<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grille de Qualification R1</title>
    <!-- Script Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- SDK Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Importations qui étaient dans app.mjs
        import { collection, addDoc, Timestamp, query, where, getDocs, doc, updateDoc, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        window.firebaseIsReady = false;
        let db, auth, appId, userId;
        try {
            const firebaseConfig = { apiKey: "AIzaSyCpRtHQd8oybG-uZKBRz-a2uKQCHrXMapY", authDomain: "closing-gia.firebaseapp.com", projectId: "closing-gia", storageBucket: "closing-gia.firebasestorage.app", messagingSenderId: "260776101981", appId: "1:260776101981:web:30d795f1d04a44d19f65b4" };
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const authPromise = new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) { userId = user.uid; console.log("Auth prête:", userId); resolve(); }
                    else { try { await signInAnonymously(auth); console.log("Connecté anonymement."); resolve(); } catch (e) { console.error("Err anon:", e); resolve(); } }
                });
            });
            authPromise.then(() => {
                window.firebaseServices = { db, auth, appId }; // Exposer les services
                window.firebaseIsReady = true; 
                console.log("Firebase services exposed and ready flag set.");
                document.dispatchEvent(new CustomEvent('firebaseReady')); // Déclencher l'événement
            });
        } catch (error) {
            console.error("Err init Firebase:", error);
            const errorDiv = document.createElement('div'); errorDiv.className = 'fixed top-0 left-0 w-full p-4 bg-red-800 text-white text-center z-[100]'; errorDiv.textContent = 'Erreur critique: Connexion DB impossible.'; document.body.prepend(errorDiv);
        }
    </script>

    <!-- Styles CSS -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #475569 #1f2937; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 10px; border: 2px solid #1f2937; }
        #pdf-spinner { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #pdf-spinner::after { content:''; width: 50px; height: 50px; border: 4px solid #475569; border-top-color: #38bdf8; border-radius: 50%; animation: spin 1s linear infinite; }
        #pdf-spinner-text { color: white; margin-top: 1rem; font-weight: 500; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #appFeedback { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); color: white; font-weight: 600; font-size: 0.875rem; z-index: 50; transition: opacity 300ms ease-in-out; opacity: 0; pointer-events: none; }
        #appFeedback.show { opacity: 1; pointer-events: auto; }
        .l { display: block; font-size: 0.875rem; font-weight: 500; color: #d1d5db; margin-bottom: 0.5rem; }
    </style>

</head>
<body class="bg-gradient-to-b from-gray-900 to-slate-900 text-white h-full overflow-hidden font-[Inter,sans-serif]">

    <div id="app" class="h-full">
        <!-- ÉCRAN PRINCIPAL -->
        <div id="mainScreen" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 h-full p-4 md:p-6 w-full max-w-7xl mx-auto">
            <!-- Colonne Gauche -->
            <div id="leftColumn" class="md:col-span-2 space-y-4 h-full flex flex-col overflow-hidden">
                <div class="flex justify-between items-center p-2 flex-shrink-0">
                    <a id="mainBackButton" href="./dashboard.html" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-3 text-sm rounded-lg transition-colors duration-200">&larr; Retour Dashboard</a>
                    <h2 class="text-lg font-semibold text-gray-300">Prospect: <span id="mainProspectName" class="text-white font-bold"></span></h2>
                    <a id="resetButton" href="./index.html" class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-3 text-sm rounded-lg transition-colors duration-200">Reset</a>
                </div>
                <!-- Coach Questions -->
                <div id="questionCoachContainer" class="bg-slate-900/50 rounded-xl border border-amber-500/50 shadow-lg flex-shrink-0">
                    <button id="coachToggleTrigger" class="flex items-center justify-between w-full text-lg font-semibold text-amber-300 p-4">
                        <span class="flex items-center"><svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>Coach Questions</span>
                        <svg id="coachToggleIcon" class="w-5 h-5 transition-transform duration-300 transform -rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <ul id="questionCoachList" class="text-xs text-gray-200 space-y-1 p-4 pt-0 border-t border-amber-500/30 hidden"></ul>
                </div>
                <!-- Conteneur Badges -->
                <div id="leftColumnContent" class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                    <div class="bg-slate-800/70 backdrop-blur-sm border border-slate-700/50 p-5 rounded-xl shadow-lg space-y-5 mb-6">
                        <div class="space-y-6 pt-4">
                            <!-- Badges HTML -->
                            <fieldset class="border border-slate-700 rounded-lg p-4"><legend class="text-lg font-semibold text-teal-300 px-2">Compétence</legend><div class="space-y-6"><div><label class="block text-sm font-medium text-gray-300 mb-2">Expérience Totale</label><div id="contextExperienceContainer" class="flex flex-wrap gap-2"></div></div><div><label class="block text-sm font-medium text-gray-300 mb-2">Parcours / Cours Suivis</label><div id="contextParcoursContainer" class="flex flex-wrap gap-2"></div></div></div></fieldset>
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Matériel</label><div id="contextMaterielContainer" class="flex flex-wrap gap-2"></div></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Style</label><div id="contextStyleContainer" class="flex flex-wrap gap-2"></div></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Objectifs</label><div id="contextDouleursContainer" class="flex flex-wrap gap-2"></div></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Temps Dispo</label><div id="contextTempsContainer" class="flex flex-wrap gap-2"></div></div>
                            <hr class="border-slate-700">
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Statut</label><div id="contextStatutContainer" class="flex flex-wrap gap-2"></div></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Tranche d'Âge</label><div id="contextAgeContainer" class="flex flex-wrap gap-2"></div></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-2">Conséquence si inaction</label><div id="contextConsequenceContainer" class="flex flex-wrap gap-2"></div></div>
                        </div>
                    </div>
                </div>
                 <!-- Feedback Element -->
                 <div id="appFeedback" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl text-white font-semibold text-sm z-50 transition-opacity duration-300 opacity-0 pointer-events-none"></div>
            </div>

            <!-- Colonne Droite -->
            <aside id="dashboardColumn" class="md:col-span-1 h-full overflow-y-auto custom-scrollbar">
                <div id="dashboardContent" class="sticky top-0 space-y-5 bg-slate-800/70 backdrop-blur-sm border border-slate-700/50 p-5 rounded-xl shadow-2xl">
                    <!-- Jauges -->
                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 shadow-inner space-y-3">
                        <h3 class="text-md font-semibold text-gray-100 text-center mb-2">Diagnostic Prospect</h3>
                        <div><span id="gaugeDispoLabel" class="text-sm font-medium text-teal-300">Dispo (Temps)</span><div class="w-full bg-slate-700 rounded-full h-3 mt-1"><div id="gaugeDispo" class="h-3 rounded-full transition-all duration-500" style="width: 0%;"></div></div></div>
                        <div><span id="gaugeMotivLabel" class="text-sm font-medium text-teal-300">Objectifs (Douleur)</span><div class="w-full bg-slate-700 rounded-full h-3 mt-1"><div id="gaugeMotiv" class="h-3 rounded-full transition-all duration-500" style="width: 0%;"></div></div></div>
                        <div><span id="gaugeAdeqLabel" class="text-sm font-medium text-teal-300">Adéquation (Vision)</span><div class="w-full bg-slate-700 rounded-full h-3 mt-1"><div id="gaugeAdeq" class="h-3 rounded-full transition-all duration-500" style="width: 0%;"></div></div></div>
                        <div><span id="gaugeCompetenceLabel" class="text-sm font-medium text-teal-300">Compétence (Niveau)</span><div class="w-full bg-slate-700 rounded-full h-3 mt-1"><div id="gaugeCompetence" class="h-3 rounded-full transition-all duration-500" style="width: 0%;"></div></div></div>
                        <div><span id="gaugeCapaLabel" class="text-sm font-medium text-teal-300">Capacité (Finances)</span><div class="w-full bg-slate-700 rounded-full h-3 mt-1"><div id="gaugeCapa" class="h-3 rounded-full transition-all duration-500" style="width: 0%;"></div></div></div>
                        <div class="text-center pt-3 border-t border-slate-700 mt-4"><span class="text-sm font-medium text-gray-300">Score Total : </span><span id="totalScore" class="text-2xl font-bold text-teal-300">0</span></div>
                    </div>
                    <!-- Statut Qualif -->
                    <div class="bg-slate-900/50 p-4 rounded-xl text-center border border-slate-700 shadow-inner"><span id="qualificationStatus" class="inline-block text-lg font-bold px-5 py-2 rounded-lg text-white bg-gray-500 shadow-lg">En attente...</span><p id="qualificationText" class="text-sm text-gray-300 mt-2 px-1">Remplir les badges...</p></div>
                    <!-- Diagnostic -->
                    <div id="finalDiagnosticContainer" class="hidden bg-slate-900/50 p-4 rounded-xl border-slate-700 shadow-inner space-y-3 border"><h3 class="text-md font-semibold text-teal-300 text-center border-b border-slate-700 pb-2">Diagnostic Final GIA</h3><div class="space-y-2 pt-2"><h4 class="text-sm font-semibold text-green-400">Points Forts:</h4><ul id="diagnosticForts" class="list-disc list-inside text-sm text-gray-200 space-y-1"></ul></div><div class="space-y-2 pt-2"><h4 class="text-sm font-semibold text-red-400" id="diagnosticVigilanceTitle">Points d'Effort:</h4><ul id="diagnosticVigilance" class="list-disc list-inside text-sm text-gray-200 space-y-1"></ul></div></div>
                    
                    <!-- Bouton Pitch (Feu Vert) -->
                    <button id="showPitchButton" class="hidden w-full text-lg font-bold py-3 px-5 rounded-lg transition-all duration-300 shadow-lg bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-800/40">Voir la Proposition GIA &rarr;</button>
                    <!-- NOUVEAU BOUTON: Sauvegarde (Feu Rouge) -->
                    <button id="saveAndExitButton" class="hidden w-full text-lg font-bold py-3 px-5 rounded-lg transition-all duration-300 shadow-lg bg-red-700 hover:bg-red-600 text-white shadow-red-800/40">
                        Enregistrer & Quitter (Feu Rouge)
                    </button>

                    <!-- Export PDF -->
                    <div class="mt-4"><button id="exportPdfButton" class="w-full text-md font-bold py-2.5 px-4 rounded-lg transition-all duration-300 shadow-lg bg-sky-700 hover:bg-sky-600 text-white shadow-sky-800/40 flex items-center justify-center space-x-2"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>Exporter PDF</span></button></div>
                    <!-- Notes -->
                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 shadow-inner mt-4"><label for="notesTextarea" class="block text-sm font-medium text-gray-300 mb-2">Résumé & Notes Perso</label><textarea id="notesTextarea" rows="6" placeholder="Badges + notes perso..." class="w-full bg-slate-800 border border-slate-600 rounded-lg py-2 px-3 text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-teal-400"></textarea></div>
                </div>
            </aside>
        </div>

        <!-- ÉCRAN PITCH GIA -->
        <div id="giaPitchScreen" class="hidden h-full flex flex-col items-center justify-center p-4">
             <div class="w-full max-w-4xl bg-slate-800/70 backdrop-blur-sm border border-teal-500/50 p-6 md:p-8 rounded-xl shadow-2xl space-y-6 flex flex-col h-full md:max-h-[90vh] overflow-y-auto custom-scrollbar">
                <!-- Contenu Pitch -->
                <h1 class="text-2xl md:text-3xl font-bold text-teal-300 mb-2 text-center">Bienvenue GIA</h1>
                <p class="text-md md:text-lg text-gray-200 text-center mb-6">...<span class="font-bold text-amber-300">système complet d'autonomie</span>.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center flex-grow">
                    <div class="bg-slate-900/50 p-5 rounded-lg border border-slate-700 shadow-lg flex flex-col items-center justify-start"><svg class="w-10 h-10 md:w-12 md:h-12 text-teal-400 mb-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg><h3 class="text-lg md:text-xl font-bold text-teal-400 mb-2">LA MÉTHODE</h3><p class="text-gray-300 text-sm">...</p></div>
                    <div class="bg-slate-900/50 p-5 rounded-lg border border-slate-700 shadow-lg flex flex-col items-center justify-start"><svg class="w-10 h-10 md:w-12 md:h-12 text-teal-400 mb-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.94-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m10.116 0a5.97 5.97 0 00-4.682-2.72m-5.438 2.72A5.97 5.97 0 016 18.72m0 0a5.97 5.97 0 01-.94-3.197m0 0c0-1.06.318-2.053.87-2.882m-1.14 0a6.062 6.062 0 01-1.636 2.882M12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" /></svg><h3 class="text-lg md:text-xl font-bold text-teal-400 mb-2">L'ACCOMPAGNEMENT</h3><p class="text-gray-300 text-sm">...</p></div>
                    <div class="bg-slate-900/50 p-5 rounded-lg border border-slate-700 shadow-lg flex flex-col items-center justify-start"><svg class="w-10 h-10 md:w-12 md:h-12 text-teal-400 mb-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" /></svg><h3 class="text-lg md:text-xl font-bold text-teal-400 mb-2">LA TRANSFORMATION</h3><p class="text-gray-300 text-sm">...</p></div>
                </div>
                <hr class="border-slate-600 my-6"/>
                <div class="bg-slate-900/60 p-4 md:p-5 rounded-lg border border-amber-500/30 text-center"><h4 class="text-lg font-semibold text-amber-300 mb-2">Engagement intensif.</h4><p class="text-gray-200 text-base">Investissement entre <span class="font-bold text-white">3000€ et 3600€</span>.</p></div>

                 <!-- Boutons Decision & Champ Raison -->
                 <div class="mt-6 space-y-4">
                     <div id="lostReasonContainer" class="hidden space-y-2 transition-all duration-300 ease-in-out">
                         <label for="lostReasonInput" class="block text-sm font-medium text-gray-300">Raison du refus (optionnel) :</label>
                         <input type="text" id="lostReasonInput" placeholder="Ex: Prix, Timing..." class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-400">
                     </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4 pt-4 border-t border-slate-700/50">
                        <button id="pitchBackButton" type="button" class="w-full sm:w-auto bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-5 text-sm md:text-md rounded-lg transition-colors duration-200 order-3 sm:order-1">&larr; Revoir Diagnostic</button>
                        <button id="rejectR2Button" type="button" class="w-full sm:w-auto bg-red-700 hover:bg-red-600 text-white font-bold py-3 px-6 text-md md:text-lg rounded-lg transition-all duration-300 shadow-lg order-2">Ne passe pas en R2</button>
                        <button id="scheduleR2ConfirmButton" type="button" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-6 text-md md:text-lg rounded-lg transition-all duration-300 shadow-lg shadow-teal-800/40 order-1 sm:order-3">Valider Passage en R2 &rarr;</button>
                    </div>
                 </div>
            </div>
        </div>
         <!-- Feedback Element -->
         <div id="appFeedback"></div>
    </div>

    <!-- Appel du module JS (Logique d'init simplifiée) -->
    <script type="module">
        // Importer les dépendances Firestore D'ABORD
        import { collection, addDoc, Timestamp, query, where, getDocs, doc, updateDoc, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTES ---
        const allBadgeNames=["Chomage/Instable","Actif/Libéral","Retraité","< 3h/sem.","3-5h/sem.","+5h/sem.","+8h/sem.","18-35 ans","36-50 ans","51-65 ans","+ 65 ans","Plaisir","Pas d'objectif","Jouer des solos","Rêve jeunesse","Challenge perso","Technique","Composer","Jeu en groupe","Liberté manche","Improviser librement","Parcours structuré","< 1 an","1-5 ans","5-10 ans","+ 10 ans","Pas de cours","< 1 an cours","1-3 ans cours","+ 3 ans cours","Pop/Chanson","Metal","Jazz/Funk","Blues/Rock","Pas de matériel","Électrique","Home Studio","Aucun","Stagnation","Abandon","Grosse frustration"];
        const badgeCategories={statut:[0,1,2],temps:[3,4,5,6],age:[7,8,9,10],douleur:[11,12,13,14,15,16,17,18,19,20,21],experience:[22,23,24,25],parcours:[26,27,28,29],style:[30,31,32,33],materiel:[34,35,36],consequence:[37,38,39,40]};
        const badgeData={0:[0,0,0,-2,0],1:[1,0,0,2,0],2:[3,0,0,3,0],3:[0,0,0,0,0],4:[2,0,0,0,0],5:[4,0,0,0,0],6:[5,0,0,0,0],7:[0,0,0,0,0],8:[0,1,0,0,0],9:[0,2,0,0,0],10:[0,2,0,0,0],11:[0,-1,-2,0,0],12:[0,-5,-2,0,0],13:[0,2,0,0,0],14:[0,2,1,0,0],15:[0,2,2,0,0],16:[0,2,0,0,0],17:[0,0,2,0,0],18:[0,0,3,0,0],19:[0,0,4,0,0],20:[0,0,5,0,0],21:[0,0,5,0,0],22:[0,0,0,0,1],23:[0,0,0,0,2],24:[0,0,0,0,3],25:[0,0,0,0,4],26:[0,1,0,0,1],27:[0,1,0,0,2],28:[0,2,0,0,3],29:[0,3,0,0,3],30:[0,0,0,0,0],31:[0,0,0,0,0],32:[0,0,1,0,0],33:[0,0,2,0,0],34:[0,0,0,-2,0],35:[0,0,0,1,0],36:[0,0,0,3,0],37:[0,-3,-1,0,0],38:[0,1,0,0,0],39:[0,2,0,0,0],40:[0,5,0,0,0]};
        const maxScores={dispo:8,motiv:18,adeq:25,capa:6,competence:7};
        const SEUILS={motiv:5,capa:2,total:35,dispo:3,adeq:3,competence:3};
        const initialState={prospectFirstName:'',prospectLastName:'',prospectDate:'',customNotes:'',currentDocId: null, isViewingMode: false, currentStatus: null, isR1Completed: false, context:{statut:'',temps:'',age:'',experience:'',parcours:'',materiel:[],douleur:[],consequence:'',style:[]}};
        const badgeColorRanks={0:'red',1:'green',2:'rainbow',3:'red',4:'green',5:'rainbow',6:'rainbow',7:'orange',8:'orange',9:'green',10:'green',11:'red',12:'red-dark',13:'green',14:'orange',15:'orange',16:'green',17:'green',18:'rainbow',19:'rainbow',20:'rainbow',21:'rainbow',22:'orange',23:'orange',24:'green',25:'rainbow',26:'orange',27:'green',28:'green',29:'rainbow',30:'orange',31:'orange',32:'green',33:'rainbow',34:'red-dark',35:'green',36:'rainbow',37:'red',38:'green',39:'green',40:'rainbow'};
        const colorRankOrder={'red-dark':0,'red':1,'orange':2,'green':3,'rainbow':4};
        const tagStyles={base:"w-[140px] min-h-[44px] inline-flex items-center justify-center text-center p-1 rounded-lg text-xs font-medium transition-all duration-200 shadow-md border",inactive:"bg-slate-700 text-slate-300 hover:bg-slate-600",active:{'rainbow':"bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg -translate-y-0.5",'green':"bg-green-600 text-white shadow-lg -translate-y-0.5",'orange':"bg-amber-600 text-white shadow-lg -translate-y-0.5",'red':"bg-red-600 text-white shadow-lg -translate-y-0.5",'red-dark':"bg-red-800 text-white shadow-lg -translate-y-0.5"},borders:{'rainbow':"border-purple-700",'green':"border-green-700",'orange':"border-amber-700",'red':"border-red-700",'red-dark':"border-red-900"}};
        const gaugeLabelColors={green:"text-green-400",red:"text-red-400",amber:"text-amber-300",neutral:"text-teal-300"};
        const diagBorderColors={green:"border-green-400 border-2 shadow-lg",red:"border-red-400 border-2 shadow-lg",neutral:"border-slate-700"};
        
        // --- Objet App (Inliné) ---
        const App = {
            state: null,
            elements: {},
            tagStyles: tagStyles,
            gaugeLabelColors: gaugeLabelColors,
            diagBorderColors: diagBorderColors,

            async init() {
                this.state = structuredClone(initialState);
                this.cacheElements();
                const params = new URLSearchParams(window.location.search);
                const docIdParam = params.get('docId');

                if (docIdParam) {
                    this.state.isViewingMode = true;
                    await this.loadProspectData(docIdParam);
                    
                    // CORRECTION CRITIQUE: Mettre à jour le statut seulement si c'était planifié.
                    // Empêche d'écraser un statut "R2 Scheduled" ou "Closed"
                    if (this.state.currentStatus === 'R1 Scheduled') {
                        // Marque le R1 comme effectué car on entre dans la grille de qualif
                        await this.updateProspectStatusAndFlags('R1 Completed', true);
                        this.state.currentStatus = 'R1 Completed';
                        this.state.isR1Completed = true; // Mettre à jour l'état local aussi
                    }
                } else {
                    this.showFeedback("Erreur: ID prospect manquant.", true);
                    console.error("ID de document manquant dans l'URL. Impossible de charger la fiche.");
                    return; // Arrêter l'initialisation
                }

                if (this.elements.mainBackButton) { this.elements.mainBackButton.href = `dashboard.html`; }
                if (this.elements.resetButton) { this.elements.resetButton.href = 'index.html'; }

                this.renderAllTags();
                this.bindEvents();
                this.updateDashboard();
                this.switchScreen('main');
            },

            cacheElements() { const $ = (id) => document.getElementById(id); const ids = ['mainScreen', 'giaPitchScreen', 'mainBackButton', 'resetButton', 'mainProspectName', 'contextStatutContainer', 'contextTempsContainer', 'contextAgeContainer', 'contextDouleursContainer', 'contextConsequenceContainer', 'contextExperienceContainer', 'contextParcoursContainer', 'contextStyleContainer', 'contextMaterielContainer', 'gaugeDispo', 'gaugeMotiv', 'gaugeAdeq', 'gaugeCapa', 'gaugeCompetence', 'gaugeDispoLabel', 'gaugeMotivLabel', 'gaugeAdeqLabel', 'gaugeCapaLabel', 'gaugeCompetenceLabel', 'totalScore', 'qualificationStatus', 'qualificationText', 'finalDiagnosticContainer', 'diagnosticForts', 'diagnosticVigilance', 'diagnosticVigilanceTitle', 'questionCoachList', 'showPitchButton', 'notesTextarea', 'pitchBackButton', 'scheduleR2ConfirmButton', 'rejectR2Button', 'lostReasonInput', 'lostReasonContainer', 'coachToggleTrigger', 'coachToggleIcon', 'exportPdfButton', 'dashboardColumn', 'dashboardContent', 'mainGrid', 'leftColumn', 'leftColumnContent', 'appFeedback', 'saveAndExitButton']; ids.forEach(id => { const el = $(id); if (el) { this.elements[id] = el; } }); },
            bindEvents() {
                this.elements.mainScreen?.addEventListener('click', (event) => { const b = event.target.closest('button[data-type]'); if (b) { this.handleTagClick(b); } });
                this.elements.notesTextarea?.addEventListener('input', (e) => this.handleNotesInput(e));
                this.elements.coachToggleTrigger?.addEventListener('click', () => { this.elements.questionCoachList?.classList.toggle('hidden'); this.elements.coachToggleIcon?.classList.toggle('-rotate-180'); });
                this.elements.exportPdfButton?.addEventListener('click', () => this.exportToPDF());
                this.elements.showPitchButton?.addEventListener('click', () => this.switchScreen('giaPitch'));
                this.elements.saveAndExitButton?.addEventListener('click', () => this.saveAndExit());
                
                this.elements.pitchBackButton?.addEventListener('click', () => this.switchScreen('main'));
                this.elements.scheduleR2ConfirmButton?.addEventListener('click', () => this.confirmR2Schedule());
                this.elements.rejectR2Button?.addEventListener('click', () => this.confirmR2Rejection());
                this.elements.rejectR2Button?.addEventListener('click', () => { this.elements.lostReasonContainer?.classList.remove('hidden'); });
                this.elements.scheduleR2ConfirmButton?.addEventListener('click', () => { this.elements.lostReasonContainer?.classList.add('hidden'); });
            },
            switchScreen(screenName) { const s = { main: this.elements.mainScreen, giaPitch: this.elements.giaPitchScreen }; if (!s.main || !s.giaPitch) return; s.main.classList.add('hidden'); s.main.classList.remove('grid'); s.giaPitch.classList.add('hidden'); s.giaPitch.classList.remove('flex'); if (screenName === 'main') { s.main.classList.remove('hidden'); s.main.classList.add('grid'); } else if (screenName === 'giaPitch') { s.giaPitch.classList.remove('hidden'); s.giaPitch.classList.add('flex'); } },
            handleTagClick(btn) { const { type, value } = btn.dataset; if (['statut', 'temps', 'age', 'consequence', 'experience', 'parcours'].includes(type)) { this.state.context[type] = (this.state.context[type] === value) ? '' : value; } else { const arr = this.state.context[type]; if (!arr) return; const index = arr.indexOf(value); if (index > -1) { arr.splice(index, 1); } else { arr.push(value); } } this.renderAllTags(); this.updateDashboard(); this.updateProspectDoc(); },
            handleNotesInput(event) { const parts = event.target.value.split("\n\n--- NOTES PERSO ---\n"); this.state.customNotes = parts.length > 1 ? parts.slice(1).join("\n\n--- NOTES PERSO ---\n").trim() : ''; this.updateProspectDoc(); },
            updateDashboard() { const { context } = this.state; const sc = this.calculateScores(context); const iR = context.statut && context.temps && context.douleur.length > 0 && context.consequence; const ql = this.updateQualification(sc, context, iR); this.updateGauges(sc); this.updateFinalDiagnostic(sc, ql, iR, context); this.updateQuestionCoach(sc, context, iR); this.updateNotes(); if (this.elements.totalScore) { this.elements.totalScore.textContent = sc.total; } },
            calculateScores(context) { const scores = { dispo: 0, motiv: 0, adeq: 0, capa: 0, competence: 0 }; const addPoints = (bt) => { if (!bt) return; const idx = allBadgeNames.indexOf(bt); if (idx === -1) return; const pts = badgeData[idx]; if (pts) { pts.forEach((p, i) => { scores[Object.keys(scores)[i]] += p; }); } }; addPoints(context.statut); addPoints(context.temps); addPoints(context.age); addPoints(context.consequence); addPoints(context.experience); addPoints(context.parcours); context.materiel.forEach(addPoints); context.douleur.forEach(addPoints); context.style.forEach(addPoints); Object.keys(scores).forEach(key => { scores[key] = Math.max(0, Math.min(scores[key], maxScores[key])); }); scores.total = scores.dispo + scores.motiv + scores.adeq + scores.capa + scores.competence; return scores; },
            updateGauges(scores) { const uG = (g, l, s, m, t, tk) => { if (!g || !l) return; const p = (s / m) * 100, pc = Math.max(0, Math.min(100, p)); g.style.width = `${pc}%`; g.classList.remove('bg-red-500', 'bg-amber-500', 'bg-green-500'); Object.values(this.gaugeLabelColors).forEach(cc => l.classList.remove(cc)); if (tk === 'motiv' || tk === 'capa') { l.classList.add(s > t ? this.gaugeLabelColors.green : this.gaugeLabelColors.red); } else { l.classList.add(s >= t ? this.gaugeLabelColors.green : this.gaugeLabelColors.amber); } if (pc < (t / m * 100)) { g.classList.add('bg-red-500'); } else if (pc < 80) { g.classList.add('bg-amber-500'); } else { g.classList.add('bg-green-500'); } }; uG(this.elements.gaugeDispo, this.elements.gaugeDispoLabel, scores.dispo, maxScores.dispo, SEUILS.dispo, 'dispo'); uG(this.elements.gaugeMotiv, this.elements.gaugeMotivLabel, scores.motiv, maxScores.motiv, SEUILS.motiv, 'motiv'); uG(this.elements.gaugeAdeq, this.elements.gaugeAdeqLabel, scores.adeq, maxScores.adeq, SEUILS.adeq, 'adeq'); uG(this.elements.gaugeCapa, this.elements.gaugeCapaLabel, scores.capa, maxScores.capa, SEUILS.capa, 'capa'); uG(this.elements.gaugeCompetence, this.elements.gaugeCompetenceLabel, scores.competence, maxScores.competence, SEUILS.competence, 'competence'); },
            
            updateQualification(scores, context, isReady) {
                const isCapable = scores.capa > SEUILS.capa; const isMotivated = scores.motiv > SEUILS.motiv; const isTotalOK = scores.total >= SEUILS.total; // Utilise 35
                let qual = { status: "En attente...", text: "...", color: "bg-gray-500", isCapable, isMotivated, isTotalOK, isFinal: isReady };
                if (!isReady) { let m = []; if (!context.statut) m.push("Statut"); if (!context.temps) m.push("Temps"); if (context.douleur.length === 0) m.push("Objectifs"); if (!context.consequence) m.push("Conséquence"); qual.text = `Remplir: ${m.join(', ')}.`; }
                else {
                    if (!isCapable || !isMotivated || !isTotalOK) { qual.status = "FEU ROUGE"; qual.text = "Inqualifiable. Pas de R2."; qual.color = "bg-red-600"; }
                    else { const isIdeal = scores.total >= 40; qual.status = `FEU VERT ${isIdeal ? "(Client Rêvé)" : ""}`; qual.text = "Prospect qualifié !"; qual.color = isIdeal ? "bg-emerald-600" : "bg-green-600"; }
                }
                if (this.elements.qualificationStatus) { this.elements.qualificationStatus.textContent = qual.status; this.elements.qualificationStatus.className = `inline-block text-lg font-bold px-5 py-2 rounded-lg text-white shadow-lg ${qual.color}`; }
                if (this.elements.qualificationText) { this.elements.qualificationText.textContent = qual.text; }
                const showVertButton = qual.status.includes("VERT");
                const showRougeButton = qual.status.includes("ROUGE") && isReady;
                this.elements.showPitchButton?.classList.toggle('hidden', !showVertButton);
                this.elements.saveAndExitButton?.classList.toggle('hidden', !showRougeButton);
                return qual;
            },

            updateFinalDiagnostic(scores, qual, isReady, context) {
                const c = this.elements.finalDiagnosticContainer; if (!c) return; const { diagnosticForts: fE, diagnosticVigilance: vE, diagnosticVigilanceTitle: vt } = this.elements; Object.values(this.diagBorderColors).forEach(cls => cls.split(' ').forEach(cn => c.classList.remove(cn)));
                if (!isReady) { c.classList.add('hidden'); this.diagBorderColors.neutral.split(' ').forEach(cn => c.classList.add(cn)); return; } c.classList.remove('hidden'); const { isCapable, isMotivated } = qual; const ig = qual.status.includes("VERT"); const ir = qual.status.includes("ROUGE");
                
                if (ig) { this.diagBorderColors.green.split(' ').forEach(cn => c.classList.add(cn)); if (vt) vt.textContent = "Tes Points d'Effort (Pour réussir)"; }
                else if (ir) { this.diagBorderColors.red.split(' ').forEach(cn => c.classList.add(cn)); if (vt) vt.textContent = "Points d'Alerte (Ce qui manque)"; }
                else { this.diagBorderColors.neutral.split(' ').forEach(cn => c.classList.add(cn)); }
                
                if (fE) fE.innerHTML = ''; if (vE) vE.innerHTML = ''; let fm = []; let vm = [];
                if (isMotivated) { const vst=context.douleur.includes("Improviser librement")?"...": "..."; fm.push(`Motivation claire... ('${context.consequence||'N/A'}') = moteurs.`); } if (scores.competence >= SEUILS.competence) { fm.push(`Expérience ('${context.experience || 'N/A'}') = bon départ...`); } if (scores.dispo >= SEUILS.dispo) { fm.push(`Disponibilité ('${context.temps || 'N/A'}') = prêt à investir...`); } if (fm.length === 0 && !ig && fE) { fE.innerHTML = `...`; }
                
                if (!isCapable) { vm.push(`Focus : *capacité à t'investir*...`); } 
                if (!isMotivated) { vm.push(`Focus : *Envie*. GIA intensive...`); } 
                if (scores.dispo < SEUILS.dispo) { vm.push(`Focus : *Temps*. '${context.temps}'...`); } 
                if (scores.adeq < SEUILS.adeq && !context.douleur.includes("Jouer des solos")) { vm.push(`Focus : *Vision*. ('${context.douleur[0]||'N/A'}')...`); }
                
                if (scores.competence < SEUILS.competence && (context.experience === "< 1 an" || context.parcours === "Pas de cours")) { 
                    vm.push(`Point de focus : *Motivation & Discipline*. Profil débutant. S'assurer de la réelle motivation face au défi, clarifier les efforts requis...`); 
                } else if (scores.competence < SEUILS.competence) { 
                    vm.push(`Focus : *Humilité*. Niveau ('${context.experience||'N/A'}')...`); 
                }
                
                if (context.douleur.includes("Jouer des solos")) { vm.push(`Focus (Adéquation) : 'Jouer solos' = 'piège à tablatures'...`); } if (context.douleur.includes("Technique")) { vm.push(`Focus (Volonté) : Blocage 'Technique' = 'fausse douleur'...`); } if (context.consequence === "Aucun") { vm.push(`Focus (Urgence) : Conséquence ('Aucun') = *manque d'urgence*...`); } if (vm.length === 0 && ig && vE) { vE.innerHTML = `<li class="text-green-300 italic">Aucune réserve majeure...</li>`; }
                
                fm.forEach(t => { if (fE) fE.innerHTML += `<li>${t.replace(/\*(.*?)\*/g, '<span class="font-semibold text-white">$1</span>')}</li>`; }); 
                vm.forEach(t => { if (vE) vE.innerHTML += `<li>${t.replace(/\*(.*?)\*/g, '<span class="font-semibold text-white">$1</span>')}</li>`; });
            },

            updateQuestionCoach(scores, context, isReady) { const lE=this.elements.questionCoachList; if(!lE)return; let qs=[]; const {statut:s,temps:t,douleur:d,consequence:c,experience:e,parcours:p,style:st,materiel:m}=context; if(d.length===0){qs.push(`*Rêve* guitariste ? (→ *Vise 'Impro...'*)`);} if(!c){qs.push(`Dans 6 mois sans changement...? (→ *Vise 'Frustration'*)`);} if(!t){qs.push(`Heures/sem *vraiment* prêt à bloquer ? (→ *Vise '+5h'*)`);} if(!s){qs.push(`Actif ou + temps libre (retraité...) ? (→ *Vise 'Retraité'*)`);} if(e===''){qs.push(`Joues depuis combien temps ?`);} if(p===''){qs.push(`Déjà suivi cours structurés ?`);} if(st.length===0){qs.push(`Styles envie jouer ? (→ *Vise 'Blues/Rock'*)`);} if(m.length===0){qs.push(`Type guitare ? (→ *Vise 'Électrique'*)`);} if(isReady&&qs.length===0){if(scores.dispo<SEUILS.dispo){qs.push(`[ALERTE TEMPS 🔴] '${t}' vs 5h min. Où trouver heures ?`);} if(scores.capa<=SEUILS.capa){qs.push(`[ALERTE CAPA 🔴] Déjà investi k€ ? Comment vois-tu investissement ?`);} if(scores.motiv<=SEUILS.motiv){qs.push(`[ALERTE MOTIV 🔴] Objectif '${d.join(', ')}'. Pourquoi iras au bout cette fois ?`);} if(c==="Aucun"){qs.push(`[ALERTE URGENCE 🟠] Pas de conséquence. Pourquoi *maintenant* ?`);} if(scores.adeq<SEUILS.adeq&&!d.includes("Jouer des solos")){qs.push(`[ALERTE VISION 🟠] Objectif '${d[0]}'. Prêt 3 mois théorie avant résultats ?`);} if(d.includes("Jouer des solos")){qs.push(`[ALERTE VISION 🟠] 'Jouer solos'. Prêt focus *compréhension* avant plans ?`);} if(d.includes("Technique")){qs.push(`[ALERTE VOLONTÉ 🟠] Blocage 'Technique'. Prêt accepter vrai problème ailleurs ?`);}} if(isReady&&qs.length===0){lE.innerHTML=`<li class="text-green-300 italic">Excellent profil ! Prépare le R2.</li>`;} else if(qs.length===0){lE.innerHTML=`<li class="text-gray-400 italic">Remplis badges...</li>`;} else {lE.innerHTML=qs.map(q=>{let fq=q.replace(/(\(→.*?\))/g,'<span class="text-amber-400/60 italic text-xs">$1</span>'); if(q.includes("[ALERTE")){fq=fq.replace(/\[ALERTE.*?(\p{Emoji}).*?\]/gu,'<span class="font-semibold text-red-300">Alerte $1 :</span>');} fq=fq.replace(/\*(.*?)\*/g,'<span class="font-semibold text-white">$1</span>'); return `<li class="pb-1">${fq}</li>`;}).join('');} },
            updateNotes() { if(!this.elements.notesTextarea)return; const {context,customNotes}=this.state; const sb=[context.statut,context.temps,context.age,context.consequence,context.experience,context.parcours,...context.materiel,...context.douleur,...context.style].filter(Boolean); let gn=sb.join('\n'); this.elements.notesTextarea.value=gn+`\n\n--- NOTES PERSO ---\n`+customNotes; },
            renderAllTags() { const { context } = this.state; this.renderTags('contextStatutContainer','statut',context.statut); this.renderTags('contextTempsContainer','temps',context.temps); this.renderTags('contextAgeContainer','age',context.age); this.renderTags('contextExperienceContainer','experience',context.experience); this.renderTags('contextParcoursContainer','parcours',context.parcours); this.renderTags('contextConsequenceContainer','consequence',context.consequence); this.renderTags('contextMaterielContainer','materiel',context.materiel,true); this.renderTags('contextStyleContainer','style',context.style,true); this.renderTags('contextDouleursContainer','douleur',context.douleur,true); },
            renderTags(cId, type, cV, isM = false) { const c=this.elements[cId]; if(!c)return; c.innerHTML=''; const bi=badgeCategories[type]; if(!bi)return; const sbi=[...bi].sort((a,b)=>(colorRankOrder[badgeColorRanks[a]||'orange'] - colorRankOrder[badgeColorRanks[b]||'orange'])); sbi.forEach(idx=>{const bt=allBadgeNames[idx]; if(!bt)return; const isSel=isM?cV.includes(bt):cV===bt; const btn=document.createElement('button'); btn.dataset.type=type; btn.dataset.value=bt; btn.textContent=bt; const ck=badgeColorRanks[idx]||'orange'; const stateStyle=isSel?this.tagStyles.active[ck]:this.tagStyles.inactive; const borderStyle=this.tagStyles.borders[ck]; btn.className=`${this.tagStyles.base} ${stateStyle} ${borderStyle}`; c.appendChild(btn);}); },
            
            async exportToPDF() {
                const prospectName = `${this.state.prospectFirstName} ${this.state.prospectLastName}`; const { prospectDate } = this.state; const filename = `Fiche_Qualif_GIA_${prospectName.replace(/\s+/g, '_') || 'Prospect'}_${prospectDate || 'date'}.pdf`;
                const spinner = document.createElement('div'); spinner.id = 'pdf-spinner'; spinner.innerHTML = '<span id="pdf-spinner-text">Génération PDF...</span>'; document.body.appendChild(spinner);
                const coach = this.elements.questionCoachContainer; const gaugeCapa = this.elements.gaugeCpa?.parentElement; const totalScoreEl = this.elements.totalScore?.parentElement; const vigilanceItems = this.elements.diagnosticVigilance?.querySelectorAll('li'); let financialAlertItem = null; vigilanceItems?.forEach(item => { if (item.textContent.includes("capacité") || item.textContent.includes("investir")) { financialAlertItem = item; } });
                const mainGrid = this.elements.mainGrid; const leftCol = this.elements.leftColumn; const dashboardCol = this.elements.dashboardColumn;
                const coachOrigDisplay = coach ? coach.style.display : ''; const capaOrigDisplay = gaugeCapa ? gaugeCapa.style.display : ''; const scoreOrigDisplay = totalScoreEl ? totalScoreEl.style.display : ''; const alertOrigDisplay = financialAlertItem ? financialAlertItem.style.display : ''; const gridOrigLayout = mainGrid ? mainGrid.style.gridTemplateColumns : ''; const leftColOrigSpan = leftCol ? leftCol.className : ''; const dashColOrigSpan = dashboardCol ? dashboardCol.className : '';
                try {
                    if (coach) coach.style.display = 'none'; if (gaugeCapa) gaugeCapa.style.display = 'none'; if (totalScoreEl) totalScoreEl.style.display = 'none'; if (financialAlertItem) financialAlertItem.style.display = 'none';
                    if (mainGrid) mainGrid.style.gridTemplateColumns = '1fr'; if (leftCol) leftCol.className = leftCol.className.replace('md:col-span-2', 'col-span-1'); if (dashboardCol) dashboardCol.className = dashboardCol.className.replace('md:col-span-1', 'col-span-1');
                    await new Promise(r => setTimeout(r, 150));
                    const { jsPDF } = window.jspdf; if (!jsPDF || !window.html2canvas) throw new Error("Libs PDF manquantes!");
                    const canvas = await window.html2canvas(this.elements.mainScreen, { useCORS: true, backgroundColor: '#0f172a', scale: 1.5, logging: false, windowWidth: 800 });
                    const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF('p', 'mm', 'a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight(); const canvasWidth = canvas.width, canvasHeight = canvas.height; const canvasRatio = canvasWidth / canvasHeight; const pdfRatio = pdfWidth / pdfHeight; let imgFinalWidth, imgFinalHeight;
                    if (canvasRatio > pdfRatio) { imgFinalWidth = pdfWidth - 20; imgFinalHeight = imgFinalWidth / canvasRatio; } else { imgFinalHeight = pdfHeight - 20; imgFinalWidth = imgFinalHeight * canvasRatio; } const x = (pdfWidth - imgFinalWidth) / 2, y = (pdfWidth - imgFinalWidth) / 2;
                    pdf.addImage(imgData, 'PNG', x, y, imgFinalWidth, imgFinalHeight); pdf.save(filename);
                } catch (e) { console.error("Err PDF:", e); }
                finally {
                    if (mainGrid) mainGrid.style.gridTemplateColumns = gridOrigLayout; if (leftCol) leftCol.className = leftColOrigSpan; if (dashboardCol) dashboardCol.className = dashColOrigSpan;
                    if (coach) coach.style.display = coachOrigDisplay; if (gaugeCapa) gaugeCapa.style.display = capaOrigDisplay; if (totalScoreEl) totalScoreEl.style.display = scoreOrigDisplay; if (financialAlertItem) financialAlertItem.style.display = alertOrigDisplay;
                    spinner.remove();
                }
            },

            async updateProspectDoc() { const { db } = window.firebaseServices || {}; const docId = this.state.currentDocId; if (!db || !docId) return; try { const { appId } = window.firebaseServices; const cP = `artifacts/${appId}/public/data/r1_closings`; const dR = doc(db, cP, docId); const scores = this.calculateScores(this.state.context); const qual = this.updateQualification(scores, this.state.context, true); const dTU = { context: this.state.context, customNotes: this.state.customNotes, scores: scores, qualificationStatus: qual.status, qualificationText: qual.text, lastUpdatedAt: Timestamp.now() }; await updateDoc(dR, dTU); } catch (error) { console.error(`Err MAJ auto doc ${docId}:`, error); this.showFeedback("Erreur sauvegarde auto!", true); } },
            
            async updateProspectStatusAndFlags(newStatus, isR1Completed = null, isR2Completed = null, reason = "", showFeedbackMsg = true) { 
                const { db } = window.firebaseServices || {}; 
                const docId = this.state.currentDocId; 
                if (!db || !docId) { 
                    if(showFeedbackMsg) this.showFeedback("Erreur MAJ statut!", true); 
                    return false; 
                } 
                try { 
                    const { appId } = window.firebaseServices; 
                    const cP = `artifacts/${appId}/public/data/r1_closings`; 
                    const dR = doc(db, cP, docId); 
                    const dTU = { status: newStatus, lastUpdatedAt: Timestamp.now() }; 

                    if (isR1Completed !== null) dTU.isR1Completed = isR1Completed;
                    if (isR2Completed !== null) dTU.isR2Completed = isR2Completed;

                    if (newStatus === 'Lost' || newStatus.startsWith('No Show')) { 
                        dTU.lostReason = reason || ""; 
                    } else { 
                        dTU.lostReason = deleteField(); 
                    } 
                    
                    await updateDoc(dR, dTU); 
                    this.state.currentStatus = newStatus; 
                    if(showFeedbackMsg) this.showFeedback(`Statut MàJ: ${newStatus.replace('Scheduled', 'Planifié').replace('Completed', 'Effectué')}`, false); 
                    return true; 
                } catch (e) { 
                    console.error(`Err MAJ statut (${newStatus}) ${docId}:`, e); 
                    if(showFeedbackMsg) this.showFeedback("Erreur MAJ statut!", true); 
                    return false; 
                } 
            },

            async confirmR2Schedule() { 
                const success = await this.updateProspectStatusAndFlags('R2 Scheduled', true, true); 
                if (success) { 
                    setTimeout(() => { window.location.href = './dashboard.html'; }, 1000); 
                } 
            },
            async confirmR2Rejection() { 
                const reason = this.elements.lostReasonInput?.value.trim() || ""; 
                const success = await this.updateProspectStatusAndFlags('Lost', this.state.isR1Completed, false, reason); 
                if (success) { 
                    setTimeout(() => { window.location.href = './dashboard.html'; }, 1000); 
                } 
            },
            
            async loadProspectData(docId) {
                const { db } = window.firebaseServices || {};
                if (!db) { this.showFeedback("Erreur DB", true); return; }
                try {
                    const { appId } = window.firebaseServices;
                    const cP = `artifacts/${appId}/public/data/r1_closings`;
                    const dR = doc(db, cP, docId);
                    const dS = await getDoc(dR);
                    if (dS.exists()) {
                        const data = dS.data();
                        this.state.currentDocId = docId;
                        this.state.prospectFirstName = data.prospectFirstName || ''; this.state.prospectLastName = data.prospectLastName || '';
                        this.state.prospectDate = data.prospectDate || '';
                        this.state.context = { ...initialState.context, ...(data.context || {}) };
                        this.state.context.materiel = Array.isArray(this.state.context.materiel) ? this.state.context.materiel : [];
                        this.state.context.douleur = Array.isArray(this.state.context.douleur) ? this.state.context.douleur : [];
                        this.state.context.style = Array.isArray(this.state.context.style) ? this.state.context.style : [];
                        this.state.customNotes = data.customNotes || '';
                        this.state.currentStatus = data.status || 'R1 Scheduled';
                        this.state.isR1Completed = data.isR1Completed || false; // Charger la checkbox
                        if (this.elements.mainProspectName) { this.elements.mainProspectName.textContent = data.prospectName || 'Inconnu'; }
                    } else {
                        console.error(`Doc ${docId} non trouvé!`);
                        this.showFeedback("Erreur: Fiche non trouvée!", true);
                        this.state.currentDocId = null;
                    }
                } catch (error) {
                    console.error(`Err chargement doc ${docId}:`, error);
                    this.showFeedback("Erreur chargement fiche!", true);
                    this.state.currentDocId = null;
                }
            },
            showFeedback(message, isError = false, buttonElement = null, successText = null) { let fE=document.getElementById('appFeedback'); if(!fE){console.warn("Feedback element not found"); return;} fE.textContent=message; fE.classList.remove('bg-red-600','bg-green-600','opacity-0','show'); fE.classList.add(isError?'bg-red-600':'bg-green-600','show'); if(!isError&&buttonElement&&successText){buttonElement.textContent=successText;} setTimeout(()=>{fE.classList.remove('show');fE.classList.add('opacity-0');},3000); },
            
            async saveAndExit() {
                const btn = this.elements.saveAndExitButton;
                if (btn) { btn.disabled = true; btn.textContent = "Sauvegarde..."; }
                await this.updateProspectDoc(); // Sauvegarde finale
                // Le statut est déjà 'Feu Rouge', on ne le change pas ici.
                this.showFeedback("Fiche 'Feu Rouge' enregistrée.", false);
                setTimeout(() => {
                    window.location.href = './dashboard.html';
                }, 1000);
            }
        };

        // --- Initialisation ---
        function initializeApp() {
            if (window.appInitialized) return; 
            window.appInitialized = true;
            console.log("Initialisation de l'App...");
            App.init();
        }

        if (window.firebaseIsReady) {
            console.log("Firebase déjà prêt, init immédiate.");
            initializeApp();
        } else {
            console.log("Attente de l'événement firebaseReady...");
            document.addEventListener('firebaseReady', initializeApp, { once: true });
        }
    </script>

</body>
</html>