

<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - GIA Closing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style type="text/tailwindcss">
        @layer base {
            body { font-family: 'Inter', sans-serif; }
        }
        @layer components {
            /* Badges de Statut */
            .status-badge { @apply px-2 py-0 rounded-full text-xs font-bold; }
            .status-scheduled { background-color: #fbbf24; color: #78350f; } /* R1 Planifié */
            .status-waiting { background-color: #60a5fa; color: #1e3a8a; } /* "En Attente" */
            .status-noshow-r1 { background-color: #f87171; color: #7f1d1d; }
            .status-noshow-r2 { background-color: #fb923c; color: #7c2d12; }
            .status-disqualified { background-color: #f97316; color: #7c2d12; } /* Orange */
            .status-r1 { background-color: #2563eb; color: #dbeafe; }
            .status-r2 { background-color: #9333ea; color: #f3e8ff; }
            .status-closed { background-color: #16a34a; color: #dcfce7; }
            .status-lost { background-color: #dc2626; color: #fee2e2; }
            .status-other { background-color: #4b5563; color: #f3f4f6; }
            
            .installments-fields.hidden, .modal.hidden { display: none; }
            input[type="date"]:invalid { border-color: #f87171; }
            input:read-only {
                background-color: #374151; /* gray-700 */
                cursor: not-allowed;
                opacity: 0.7;
            }
            
            /* KPI Secondaire (pour Nombres) */
            .kpi-secondary-value { 
                font-size: 0.875rem; /* text-sm */
                font-weight: 600; /* font-semibold */
                color: #9ca3af; /* gray-400 */
                margin-left: 0.25rem; /* ml-1 */
            }
            .kpi-secondary-value.text-red-400 { color: #f87171; }
            .kpi-secondary-value.text-orange-400 { color: #fb923c; }
            
            .date-shortcut, .view-toggle { @apply text-sm font-medium text-gray-400 hover:text-white px-3 py-1 rounded-md transition-colors; }
            .date-shortcut.active, .view-toggle.active { @apply bg-blue-600 text-white; }
            .date-shortcut:disabled, .view-toggle:disabled { @apply opacity-40 cursor-not-allowed; }
            
            th { @apply px-3 py-3 bg-slate-800 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sticky top-0 z-10; }
            td { @apply px-3 py-3.5 text-sm text-gray-200 border-b border-slate-700; } /* Increased py */
            tbody tr:hover { background-color: rgba(255, 255, 255, 0.03); }
            tr:last-child td { @apply border-b-0; }
            
            /* KPI Cliquable (pour Graphique) */
            .kpi-card-toggle { @apply cursor-pointer transition-all duration-200; }
            .kpi-chart-active { @apply ring-2 ring-offset-2 ring-offset-slate-900 ring-white/70 opacity-100; }
            .kpi-card-toggle:not(.kpi-chart-active) { @apply opacity-60 hover:opacity-100; }
            .kpi-card-static { @apply bg-slate-800/80 backdrop-blur-sm border border-slate-700 p-3 rounded-lg shadow-lg text-center transition-all duration-300 relative overflow-hidden border-t-2; }
            
            /* Settings Visibility */
            .kpi-hidden-by-settings { display: none !important; }

            /* Case à cocher customisée */
            .custom-checkbox {
                @apply w-5 h-5 rounded border-2 border-slate-500 bg-slate-700 text-teal-500 shadow-sm focus:ring-teal-400 focus:ring-offset-slate-800;
            }
            .custom-checkbox.checkbox-loading {
                @apply opacity-50;
                cursor: wait; /* Utilise le curseur d'attente au lieu de bloquer */
            }

            /* Tooltip customisé */
            .tooltip-container {
                position: relative;
                display: inline-block;
            }
            .tooltip-container .tooltip-text {
                visibility: hidden;
                width: 250px;
                background-color: #1e293b; /* slate-800 */
                color: #fff;
                text-align: left;
                border-radius: 6px;
                padding: 8px 12px;
                position: absolute;
                z-index: 10;
                bottom: 125%; /* Position above the element */
                left: 50%;
                margin-left: -125px; /* Center the tooltip */
                opacity: 0;
                transition: opacity 0.3s;
                white-space: pre-wrap; /* Respect newlines in the text */
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                border: 1px solid #334155; /* slate-700 */
                pointer-events: none;
            }
            .tooltip-container:hover .tooltip-text {
                visibility: visible;
                opacity: 1;
            }

            /* Select pour le statut dans le tableau */
            .status-select {
                @apply w-full bg-slate-700 border border-slate-600 rounded-md py-1 px-2 text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-teal-400;
            }
            
            /* Jauge linéaire custom */
            .linear-gauge-container { @apply w-full h-4 bg-slate-700 rounded-full relative overflow-hidden; }
            .linear-gauge-bar { @apply h-full transition-all duration-500 ease-out; }
            .linear-gauge-marker { @apply absolute top-0 bottom-0 w-0.5 bg-white z-10; }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-gray-900 to-slate-900 text-white min-h-screen p-4 md:p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-2">
            <h1 class="text-3xl font-bold text-teal-300 mb-4 md:mb-0">Tableau de Bord GIA</h1>
            <div class="flex items-center space-x-4">
                <button id="openSettingsBtn" class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-gray-300 hover:text-white transition-colors" title="Paramètres d'affichage">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <a href="fomo_tracker.html" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 shadow-lg shadow-purple-800/40">Suivi Offres FOMO</a>
                <a href="dashboard.html" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-5 rounded-lg transition-all duration-300 shadow-lg shadow-teal-800/40"> + Planifier R1 </a>
            </div>
        </header>
        
        <!-- Top Stats Row: Référentiel + Jauge Fiabilité -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-4">
            <!-- Référentiel J-180 -->
            <section id="sliding-kpis-180" class="lg:col-span-9 bg-slate-800/30 p-4 rounded-xl border border-slate-700/50 flex flex-col justify-center">
                 <h3 class="text-sm font-semibold text-gray-400 mb-3 text-center uppercase tracking-wide">Référentiel (180 derniers jours)</h3>
                 <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm text-gray-300">
                     <span>R1 Planifiés: <strong id="kpi-180-planned" class="text-white text-base">...</strong></span>
                     <span>R1 Effectués: <strong id="kpi-180-completed" class="text-white text-base">...</strong></span>
                     <span>No Show R1: <strong id="kpi-180-noshow-r1" class="text-red-400 text-base">...</strong></span>
                     <span>Closings: <strong id="kpi-180-closed" class="text-green-400 text-base">...</strong></span>
                     <span>Conv. (Effec→Closé): <strong id="kpi-180-conv-rate" class="text-teal-300 text-base">...</strong></span>
                     <span>Cash Période: <strong id="kpi-180-cash" class="text-teal-300 text-base">...</strong></span>
                 </div>
            </section>

            <!-- Jauge Fiabilité Tunnel (Visuel Rapide) -->
            <section class="lg:col-span-3 bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center relative min-h-[140px]">
                <h3 class="text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider text-center">Fiabilité Statistique</h3>
                <div class="relative w-24 h-24">
                    <canvas id="reliabilityChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                         <span id="reliabilityCount" class="text-xl font-bold text-white">0</span>
                         <span class="text-[9px] text-gray-500">/ 30 R1</span>
                    </div>
                </div>
                <p id="reliabilityLabel" class="text-[9px] text-gray-500 mt-1 text-center truncate w-full px-2" title="Depuis la dernière ligne rouge">Depuis MAJ: <span id="lastAnnotationDateDisplay" class="text-gray-300">-</span></p>
            </section>
        </div>

        <!-- MOTEUR DE DÉCISION (NOUVEAU) -->
        <section id="decisionEngine" class="bg-slate-900 border-2 border-slate-700 p-5 rounded-xl shadow-2xl mb-6 relative overflow-hidden">
            <!-- Background Decoration -->
            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-white opacity-5 rounded-full blur-2xl pointer-events-none"></div>
            
            <div class="flex items-center gap-2 mb-4 border-b border-slate-700 pb-2">
                <svg class="w-6 h-6 text-teal-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                <h2 class="text-xl font-extrabold text-white tracking-widest uppercase">Moteur de Décision</h2>
                <span class="text-xs text-gray-500 font-mono ml-auto">ANALYSE DU <span id="decisionDate">...</span></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Gauges Column -->
                <div class="space-y-6">
                    <!-- Rappel Fiabilité -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-slate-800 rounded-lg"><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-bold">Jauge Fiabilité (Stock)</p>
                                <p class="text-sm font-mono text-white"><span id="deReliabilityValue">0</span> / 30 R1 <span id="deReliabilityPercent" class="text-xs text-gray-500">(0%)</span></p>
                            </div>
                        </div>
                        <span id="deReliabilityStatus" class="px-2 py-1 bg-slate-800 text-gray-400 text-xs font-bold rounded">EN ATTENTE</span>
                    </div>

                    <!-- Jauge Débit (Throughput) -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-slate-800 rounded-lg"><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div>
                                <div>
                                    <p class="text-xs text-gray-400 uppercase font-bold">Jauge Débit (Flux 14j)</p>
                                    <p class="text-sm font-mono text-white"><span id="deThroughputValue">0.0</span> appels / semaine</p>
                                </div>
                            </div>
                            <span id="deThroughputStatus" class="px-2 py-1 bg-red-900/50 text-red-400 text-xs font-bold rounded border border-red-900">CRITIQUE</span>
                        </div>
                        <!-- Linear Gauge Visual -->
                        <div class="linear-gauge-container">
                            <!-- Background Zones -->
                            <div class="absolute inset-0 flex h-full w-full opacity-30">
                                <div class="h-full w-[37.5%] bg-red-600"></div> <!-- 0 to 1.5 (Scale 0-4) -->
                                <div class="h-full w-[37.5%] bg-orange-500"></div> <!-- 1.5 to 3.0 -->
                                <div class="h-full w-[25%] bg-green-500"></div> <!-- 3.0 to 4.0+ -->
                            </div>
                            <!-- The Bar -->
                            <div id="deThroughputBar" class="absolute top-0 bottom-0 left-0 bg-white shadow-[0_0_10px_rgba(255,255,255,0.7)] transition-all duration-700 w-0 border-r-2 border-slate-900"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-500 mt-1 font-mono">
                            <span>0</span>
                            <span>1.5</span>
                            <span>3.0</span>
                            <span>4+</span>
                        </div>
                    </div>
                </div>

                <!-- Directive Column -->
                <div id="deDirectiveContainer" class="bg-slate-800 rounded-lg p-5 flex flex-col justify-center border-l-4 border-slate-600 transition-colors duration-300">
                    <h3 class="text-xs text-gray-400 uppercase tracking-widest mb-2 font-bold">L'ORDRE DU JOUR :</h3>
                    <p id="deMainMessage" class="text-xl md:text-2xl font-black text-white leading-tight mb-2">CHARGEMENT...</p>
                    <p id="deSubtitle" class="text-sm font-medium text-gray-300 mb-4 italic">Analyse en cours...</p>
                    <div class="bg-black/30 p-3 rounded border border-white/10">
                        <p class="text-xs text-gray-400 uppercase font-bold mb-1">Action Requise :</p>
                        <p id="deActionOrder" class="text-sm text-white font-medium">Veuillez patienter.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filtres (refonte) -->
        <section class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 space-y-4">
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                <!-- Côté gauche: Sélecteur de date -->
                <div class="flex items-center gap-3 flex-wrap">
                    <h2 class="text-lg font-semibold text-gray-300 whitespace-nowrap">Période :</h2>
                    <div class="flex items-center gap-2">
                        <label for="startDate" class="text-sm font-medium text-gray-400">Du</label>
                        <input type="date" id="startDate" required class="bg-slate-700 border border-slate-600 rounded-lg py-1.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="endDate" class="text-sm font-medium text-gray-400">Au</label>
                        <input type="date" id="endDate" required class="bg-slate-700 border border-slate-600 rounded-lg py-1.5 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400">
                    </div>
                </div>

                <!-- Côté droit: Raccourcis -->
                <div id="dateShortcuts" class="flex flex-wrap items-center gap-x-2 gap-y-2">
                    <!-- Navigation Mois -->
                    <div class="flex items-center bg-slate-700 rounded-md mr-2">
                        <button id="prevMonthBtn" class="px-3 py-1 text-gray-300 hover:text-white hover:bg-slate-600 rounded-l-md transition-colors" title="Mois précédent">&lt;</button>
                        <button data-days="month" class="date-shortcut active px-3 py-1 border-x border-slate-600 min-w-[100px]">Ce mois-ci</button>
                        <button id="nextMonthBtn" class="px-3 py-1 text-gray-300 hover:text-white hover:bg-slate-600 rounded-r-md transition-colors" title="Mois suivant">&gt;</button>
                    </div>

                    <button data-days="0" class="date-shortcut">Aujourd'hui</button>
                    <button data-days="7" class="date-shortcut">7 Jours</button>
                    <button data-days="14" class="date-shortcut">14 Jours</button>
                    <button data-days="30" class="date-shortcut">30 Jours</button>
                    <button data-days="90" class="date-shortcut">90 Jours</button>
                </div>
            </div>
        </section>

        <!-- KPIs -->
        <section class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-3" id="kpiContainer">
             <!-- Ligne 1: Tunnel R1 -->
             <div id="kpi-card-r1-planned" class="kpi-card-toggle kpi-card-static border-t-amber-500"><span id="kpiR1Planned" class="text-3xl font-bold text-amber-300 block mb-1">0</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">R1 Planifiés</span></div>
             <div id="kpi-card-disqualified" class="kpi-card-toggle kpi-card-static border-t-orange-600"><span id="kpiDisqualifiedCount" class="text-3xl font-bold text-orange-400 block mb-1">0</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Disqualifiés</span></div>
             <div id="kpi-card-r1-noshow" class="kpi-card-toggle kpi-card-static border-t-red-500"><span id="kpi-target-r1-noshow" class="absolute top-1.5 right-1.5 text-[10px] text-slate-500 font-mono">~30%</span><div class="flex items-center justify-center"><span id="kpiR1NoShowRate" class="text-3xl font-bold text-red-400 block">0%</span><span id="kpiR1NoShowCount" class="kpi-secondary-value text-red-400 block">(0)</span></div><span class="text-xs text-gray-400 font-medium uppercase tracking-wider block mt-1">% No Show R1</span></div>
             <div id="kpi-card-r1-completed" class="kpi-card-toggle kpi-card-static border-t-blue-500"><span id="kpiR1Completed" class="text-3xl font-bold text-blue-300 block mb-1">0</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">R1 Effectués</span></div>
             <div id="kpi-card-r1-to-r2" class="kpi-card-static border-t-teal-500"><span id="kpi-target-r1-to-r2" class="absolute top-1.5 right-1.5 text-[10px] text-slate-500 font-mono">35%</span><div class="flex items-center justify-center"><span id="kpiR1toR2Rate" class="text-3xl font-bold text-teal-300 block">0%</span><span id="kpiR1toR2Count" class="kpi-secondary-value block">(0)</span></div><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Conv. R1 Eff → R2</span></div>
             <div id="kpi-card-r2-count" class="kpi-card-toggle kpi-card-static border-t-purple-500"><span id="kpiR2Count" class="text-3xl font-bold text-purple-300 block mb-1">0</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">R2 Planifiés</span></div>
             
             <!-- Ligne 2: Tunnel R2 & Cash -->
             <div id="kpi-card-r2-noshow" class="kpi-card-toggle kpi-card-static border-t-orange-500"><span id="kpi-target-r2-noshow" class="absolute top-1.5 right-1.5 text-[10px] text-slate-500 font-mono">20%</span><div class="flex items-center justify-center"><span id="kpiR2NoShowRate" class="text-3xl font-bold text-orange-400 block">0%</span><span id="kpiR2NoShowCount" class="kpi-secondary-value !text-orange-400 block">(0)</span></div><span class="text-xs text-gray-400 font-medium uppercase tracking-wider block mt-1">% No Show R2</span></div>
             <div id="kpi-card-r1plan-to-closed" class="kpi-card-static border-t-teal-500"><span id="kpi-target-r1plan-to-closed" class="absolute top-1.5 right-1.5 text-[10px] text-slate-500 font-mono">10%</span><div class="flex items-center justify-center"><span id="kpiR1PlanToClosedRate" class="text-3xl font-bold text-teal-300 block">0%</span><span id="kpiR1PlanToClosedCount" class="kpi-secondary-value block">(0)</span></div><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Conv. R1 Plan → Closé</span></div>
             <div id="kpi-card-r2-to-closed" class="kpi-card-static border-t-teal-500"><span id="kpi-target-r2-to-closed" class="absolute top-1.5 right-1.5 text-[10px] text-slate-500 font-mono">55%</span><div class="flex items-center justify-center"><span id="kpiR2toClosedRate" class="text-3xl font-bold text-teal-300 block">0%</span><span id="kpiR2toClosedCount" class="kpi-secondary-value block">(0)</span></div><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Conv. R2 Eff → Closé</span></div>
             <div id="kpi-card-closing" class="kpi-card-toggle kpi-card-static border-t-green-500"><span id="kpiClosingCount" class="text-3xl font-bold text-green-300 block mb-1">0</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Closings</span></div>
             <div id="kpi-card-cash" class="kpi-card-toggle kpi-card-static border-t-teal-500"><span id="kpiCashCollected" class="text-3xl font-bold text-teal-300 block mb-1">0€</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Cash Période</span></div>
             <div id="kpi-card-waiting" class="kpi-card-toggle kpi-card-static border-t-blue-400"><span id="kpiWaitingCount" class="text-3xl font-bold text-blue-400 block mb-1">0</span><span class="text-xs text-gray-400 font-medium uppercase tracking-wider">Total "En Attente"</span></div>
        </section>

        <!-- Graphique -->
        <section class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-300">Progression</h2>
                <div class="flex space-x-2 text-sm text-gray-400">
                    <span>Cliquez sur un KPI pour filtrer le tableau et le graphique.</span>
                </div>
             </div>
             <div id="chartContainer" class="h-56 flex items-center justify-center text-gray-500">
                 <canvas id="mainChart"></canvas>
                 <span id="chartPlaceholder" class="hidden">Graphique à venir...</span>
            </div>
        </section>

        <!-- Table Détails -->
        <section class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 overflow-x-auto">
             <h2 class="text-xl font-semibold text-gray-300 mb-3 sticky top-0 bg-slate-800/90 py-2 z-20 backdrop-blur-sm">Détails des Prospects</h2>
             <table class="w-full divide-y divide-slate-700">
                <thead class="sticky top-[2.75rem] z-10">
                    <tr>
                        <th class="whitespace-nowrap">Date R1</th>
                        <th>Prospect</th>
                        <th class="text-center whitespace-nowrap">
                            <div class="tooltip-container">
                                Pré-Qualif
                                <span class="tooltip-text !w-[22rem] !-ml-[11rem] text-xs">
                                    Suivi de la pré-qualification :<br/>
                                    <span class="text-slate-400">Gris (...) :</span> Non envoyé<br/>
                                    <span class="text-blue-400">Bleu (→) :</span> Message envoyé<br/>
                                    <span class="text-green-400">Vert (✓) :</span> Pré-qualifié<br/>
                                    <span class="text-red-400">Rouge (✗) :</span> Rejeté
                                </span>
                            </div>
                        </th>
                        <th class="text-center">R1 Fait</th>
                        <th class="text-center">R2 Prévu</th>
                        <th class="text-center">Closé</th>
                        <th>Statut Final</th>
                        <th>Note</th>
                        <th class="text-right whitespace-nowrap">Montant Total</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="detailsTableBody" class="bg-slate-800 divide-y divide-slate-700"></tbody>
            </table>
        </section>
    </div>
    
    <!-- Modal Settings KPI -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-lg border border-slate-700 space-y-4">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-white">Paramètres d'Affichage KPI</h2>
                 <button id="closeSettingsBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <p class="text-sm text-gray-400">Cochez les cartes que vous souhaitez afficher sur le tableau de bord.</p>
            <div id="kpiSettingsList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- Généré par JS -->
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-slate-600">
                 <button id="saveSettingsBtn" class="bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Édition (Avec Checkboxes) -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden"> 
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-lg border border-slate-700 space-y-4 max-h-[90vh] overflow-y-auto custom-scrollbar"> 
            <h2 class="text-xl font-semibold text-teal-300">Modifier Prospect: <span id="modalProspectName"></span></h2> 
            <input type="hidden" id="modalDocId"> 
            
            <!-- Checkboxes de Progression -->
            <fieldset class="border border-slate-600 p-4 rounded-lg"> 
                <legend class="text-sm font-medium text-gray-400 px-1">Progression du Tunnel</legend> 
                <div class="space-y-4 pt-2">
                    <!-- R1 Checkbox -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="modalIsR1Completed" type="checkbox" class="custom-checkbox">
                        </div>
                        <div class="ml-3 text-sm flex-grow">
                            <label for="modalIsR1Completed" class="font-medium text-white">R1 Effectué</label>
                            <div id="modalR1Fields" class="grid grid-cols-2 gap-4 mt-2">
                                <div><label for="modalProspectDate" class="block text-xs font-medium text-gray-300 mb-1">Date R1 (non modifiable)</label><input type="date" id="modalProspectDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"></div>
                                <div><label for="modalProspectTime" class="block text-sm font-medium text-gray-300 mb-1">Heure R1 (non modifiable)</label><input type="time" id="modalProspectTime" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"></div>
                            </div>
                        </div>
                    </div>
                    <!-- R2 Checkbox -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="modalIsR2Completed" type="checkbox" class="custom-checkbox">
                        </div>
                        <div class="ml-3 text-sm flex-grow">
                            <label for="modalIsR2Completed" class="font-medium text-white">R2 Planifié/Effectué</label>
                            <div id="modalR2Fields" class="grid grid-cols-2 gap-4 mt-2 hidden">
                                <div><label for="modalProspectDateR2" class="block text-xs font-medium text-gray-300 mb-1">Date R2</label><input type="date" id="modalProspectDateR2" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"></div>
                                <div><label for="modalProspectTimeR2" class="block text-sm font-medium text-gray-300 mb-1">Heure R2</label><input type="time" id="modalProspectTimeR2" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"></div>
                            </div>
                        </div>
                    </div>
                     <!-- Closé Checkbox -->
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="modalIsClosed" type="checkbox" class="custom-checkbox">
                        </div>
                        <div class="ml-3 text-sm flex-grow">
                            <label for="modalIsClosed" class="font-medium text-white">Closé</label>
                            <div id="modalClosingDateContainer" class="mt-2 hidden">
                                <label for="modalClosingDate" class="block text-xs font-medium text-gray-300 mb-1">Date de Closing</label>
                                <input type="date" id="modalClosingDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400">
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="border border-slate-600 p-3 rounded-lg"> 
                <legend class="text-sm font-medium text-gray-400 px-1">Statut & Suivi</legend> 
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2"> 
                    <div id="modalStatusContainer"><label for="modalStatus" class="block text-sm font-medium text-gray-300 mb-1">Statut Actuel</label><select id="modalStatus" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"><option value="R1 Scheduled">R1 Planifié</option><option value="No Show R1">No Show R1</option><option value="R1 Completed">R1 Effectué</option><option value="R2 Scheduled">R2 Planifié</option><option value="No Show R2">No Show R2</option><option value="Disqualified">Disqualifié</option><option value="Waiting">En Attente</option> <option value="Closed">Closé</option> <option value="Lost">Perdu</option> <option value="Other">Autre</option></select></div> 
                    <div id="modalRelaunchDateContainer" class="hidden sm:col-span-1 space-y-1"><label for="modalRelaunchDate" class="block text-sm font-medium text-gray-300">Date de Relance</label><input type="date" id="modalRelaunchDate" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400"></div> 
                </div> 
            </fieldset> 
            
            <fieldset id="offerDetailsContainer" class="border border-slate-600 p-3 rounded-lg"> <legend class="text-sm font-medium text-gray-400 px-1">Note</legend> <div class="pt-2"> <div> <label for="modalNote" class="block text-sm font-medium text-gray-300 mb-1">Note</label> <textarea id="modalNote" placeholder="Ajouter une note..." rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400"></textarea> </div> </div> </fieldset>

            <fieldset id="paymentDetailsContainer" class="hidden border border-slate-600 p-3 rounded-lg"> <legend class="text-sm font-medium text-gray-400 px-1">Détails Paiement</legend> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2"> <div><label for="modalPaymentType" class="block text-sm font-medium text-gray-300 mb-1">Type Paiement</label><select id="modalPaymentType" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"><option value="unique">Unique</option><option value="installments">Échelonné</option></select></div> <div><label for="modalAmountCollected" class="block text-sm font-medium text-gray-300 mb-1">Montant Total Contrat (€)</label><input type="number" id="modalAmountCollected" placeholder="ex: 3600" min="0" step="any" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400"></div> </div> <div id="installmentsFields" class="installments-fields hidden grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4"> <div><label for="modalInstallmentAmount" class="block text-sm font-medium text-gray-300 mb-1">Montant Échéance (€)</label><input type="number" id="modalInstallmentAmount" placeholder="ex: 720" min="0" step="any" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400"></div> <div><label for="modalNumberOfInstallments" class="block text-sm font-medium text-gray-300 mb-1">Nb Échéances</label><input type="number" id="modalNumberOfInstallments" placeholder="ex: 5" min="1" step="1" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400"></div> <div><label for="modalStartDateOfPayment" class="block text-sm font-medium text-gray-300 mb-1">Date 1ère Échéance</label><input type="date" id="modalStartDateOfPayment" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400"></div> </div> </fieldset> 
            <div class="flex justify-end space-x-3 pt-4 border-t border-slate-600 mt-6"><button id="modalCancelButton" type="button" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Annuler</button><button id="modalSaveButton" type="button" class="bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Enregistrer</button></div> <p id="modalError" class="text-red-400 text-sm mt-2 text-center h-4"></p> 
        </div> 
    </div>
    
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden"> <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm border border-slate-700 space-y-4"> <h2 class="text-lg font-semibold text-amber-300">Confirmer Suppression</h2> <p class="text-gray-300 text-sm my-3">Supprimer "<span id="deleteProspectName" class="font-bold"></span>" ? Irréversible.</p> <input type="hidden" id="deleteDocId"> <div class="flex justify-end space-x-3 pt-4"> <button id="deleteCancelButton" type="button" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Annuler</button> <button id="deleteConfirmButton" type="button" class="bg-red-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Supprimer</button> </div> <p id="deleteError" class="text-red-400 text-sm mt-2 text-center h-4"></p> </div> </div>
    <div id="startR1ConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden"> <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm border border-slate-700 space-y-4"> <h2 class="text-lg font-semibold text-teal-300">Démarrer R1</h2> <p class="text-gray-300 text-sm my-3">Le prospect "<span id="startR1ProspectName" class="font-bold"></span>" est-il présent ?</p> <input type="hidden" id="startR1DocId"> <div class="flex flex-col sm:flex-row justify-between space-y-2 sm:space-y-0 sm:space-x-3 pt-4"> <button id="noShowButton" type="button" class="w-full sm:w-auto bg-red-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Absent (No Show)</button> <button id="startR1ConfirmButton" type="button" class="w-full sm:w-auto bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Présent (Démarrer)</button> </div> <div class="flex justify-center pt-2"> <button id="startR1CancelButton" type="button" class="text-gray-400 hover:text-gray-300 text-sm">Annuler</button> </div> <p id="startR1Error" class="text-red-400 text-sm mt-2 text-center h-4"></p> </div> </div>

    <!-- Annotation Modal -->
    <div id="annotationModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden"> 
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md border border-slate-700 space-y-4"> 
            <h2 class="text-xl font-semibold text-teal-300">Ajouter un Événement au Graphique</h2> 
            <div>
                <label for="annotationDate" class="block text-sm font-medium text-gray-300 mb-1">Date de l'événement</label>
                <input type="date" id="annotationDate" required class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-400">
            </div>
            <div>
                <label for="annotationComment" class="block text-sm font-medium text-gray-300 mb-1">Description (ex: "Changement de prix")</label>
                <textarea id="annotationComment" rows="3" required placeholder="Description brève de l'événement" class="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 px-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400"></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-slate-600 mt-4">
                <button id="annotationCancelButton" type="button" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Annuler</button>
                <button id="annotationSaveButton" type="button" class="bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Enregistrer</button>
            </div> 
            <p id="annotationError" class="text-red-400 text-sm mt-2 text-center h-4"></p> 
        </div> 
    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, doc, updateDoc, Timestamp, deleteDoc, deleteField, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth, appId;
        let currentData = [];
        let annotationsData = [];
        let mainChartInstance = null; 
        let reliabilityChartInstance = null;
        let currentViewMode = 'period';
        
        // Configuration des KPIs
        const kpiDefinitions = [
            { id: 'kpi-card-r1-planned', label: 'R1 Planifiés', defaultVisible: true },
            { id: 'kpi-card-disqualified', label: 'Disqualifiés', defaultVisible: true },
            { id: 'kpi-card-r1-noshow', label: '% No Show R1', defaultVisible: true },
            { id: 'kpi-card-r1-completed', label: 'R1 Effectués', defaultVisible: true },
            { id: 'kpi-card-r1-to-r2', label: 'Conv. R1 Eff → R2', defaultVisible: true, notToggleable: true }, // Not toggleable on chart
            { id: 'kpi-card-r2-count', label: 'R2 Planifiés', defaultVisible: true },
            { id: 'kpi-card-r2-noshow', label: '% No Show R2', defaultVisible: true },
            { id: 'kpi-card-r1plan-to-closed', label: 'Conv. R1 Plan → Closé', defaultVisible: true, notToggleable: true },
            { id: 'kpi-card-r2-to-closed', label: 'Conv. R2 Eff → Closé', defaultVisible: true, notToggleable: true },
            { id: 'kpi-card-closing', label: 'Closings', defaultVisible: true },
            { id: 'kpi-card-cash', label: 'Cash Période', defaultVisible: true },
            { id: 'kpi-card-waiting', label: 'Total "En Attente"', defaultVisible: true }
        ];

        // --- Fonctions Utilitaires ---
        function addMonths(date, months) { const d = new Date(date); d.setMonth(d.getMonth() + months); if (d.getDate() !== new Date(date).getDate()) { d.setDate(0); } return d; }
        function parseDateString(dateString) { if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return null; const parts = dateString.split('-'); return new Date(Date.UTC(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10))); }
        function getISODate(date) { return date.toISOString().split('T')[0]; }
        function getISODateWithOffset(days) { const date = new Date(); date.setDate(date.getDate() + days); return date.toISOString().split('T')[0]; }
        function getHHMMTime(date) { return date.toTimeString().split(' ')[0].substring(0, 5); }
        function formatFirebaseTimestamp(timestamp) { if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A'; try { return timestamp.toDate().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch (e) { return 'Date invalide'; } }
        function formatDateToDDMM(dateString) { if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { return dateString || '-'; } const parts = dateString.split('-'); return `${parts[2]}/${parts[1]}`; }
        async function initFirebase() { try { const fC = { apiKey: "AIzaSyCpRtHQd8oybG-uZKBRz-a2uKQCHrXMapY", authDomain: "closing-gia.firebaseapp.com", projectId: "closing-gia", storageBucket: "closing-gia.firebasestorage.app", messagingSenderId: "260776101981", appId: "1:260776101981:web:30d795f1d04a44d19f65b4" }; appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const app = initializeApp(fC); db = getFirestore(app); auth = getAuth(app); return new Promise((resolve) => { onAuthStateChanged(auth, async (user) => { if (user) { resolve(); } else { try { await signInAnonymously(auth); resolve(); } catch (e){ console.error("Err anon:", e); resolve(); }} }); }); } catch (error) { console.error("Erreur init Firebase:", error); displayError("Erreur connexion DB."); return Promise.reject(error); } }
        const safeSet = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
        function updateTargetColor(targetId, kpiValue) {
            const targetEl = document.getElementById(targetId);
            if (!targetEl) return;
            let isGoalMet = false;
            switch (targetId) {
                case 'kpi-target-r1-noshow': isGoalMet = kpiValue <= 30; break;
                case 'kpi-target-r1-to-r2': isGoalMet = kpiValue >= 30 && kpiValue <= 35; break;
                case 'kpi-target-r2-noshow': isGoalMet = kpiValue <= 20; break;
                case 'kpi-target-r1plan-to-closed': isGoalMet = kpiValue >= 10; break;
                case 'kpi-target-r2-to-closed': isGoalMet = kpiValue >= 55; break;
                default: return; 
            }
            targetEl.classList.remove('text-slate-500', 'text-green-400', 'text-red-400');
            if (isGoalMet) targetEl.classList.add('text-green-400'); else targetEl.classList.add('text-red-400');
        }

        function getActiveKpiFilters() {
            const activeKpis = new Set();
            document.querySelectorAll('.kpi-card-toggle.kpi-chart-active').forEach(card => {
                activeKpis.add(card.id);
            });
            return activeKpis;
        }

        function filterDataByKpis(data, activeKpis) {
            if (activeKpis.size === 0) return data;
            
            if (activeKpis.size === 1 && activeKpis.has('kpi-card-r1-planned')) {
                return data;
            }

            return data.filter(item => {
                let matches = false;
                if (activeKpis.has('kpi-card-r1-planned')) matches = true; 
                if (activeKpis.has('kpi-card-disqualified') && item.status === 'Disqualified') matches = true;
                if (activeKpis.has('kpi-card-r1-noshow') && item.status === 'No Show R1') matches = true;
                if (activeKpis.has('kpi-card-r1-completed') && item.isR1Completed === true) matches = true;
                if (activeKpis.has('kpi-card-r2-count') && (item.isR2Completed === true || item.status === 'No Show R2' || item.status === 'R2 Scheduled')) matches = true;
                if (activeKpis.has('kpi-card-r2-noshow') && item.status === 'No Show R2') matches = true;
                if (activeKpis.has('kpi-card-closing') && item.isClosed === true) matches = true;
                if (activeKpis.has('kpi-card-cash') && item.isClosed === true) matches = true;
                if (activeKpis.has('kpi-card-waiting') && item.status === 'Waiting') matches = true;

                return matches;
            });
        }

        function renderFilteredData() {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const filterStartDate = parseDateString(startDateStr);
            const filterEndDate = parseDateString(endDateStr);
            if (!filterStartDate || !filterEndDate) { displayError("Dates de filtre invalides."); return; }
            filterEndDate.setUTCHours(23, 59, 59, 999);
            
            const dataForPeriod = currentData.filter(item => { 
                const itemR1Date = parseDateString(item.prospectDate); 
                return itemR1Date && itemR1Date >= filterStartDate && itemR1Date <= filterEndDate; 
            });
            
            let tableData;
            if (currentViewMode === 'waiting') {
                tableData = currentData.filter(item => item.status === 'Waiting');
                tableData.sort((a, b) => (a.relaunchDate || '9999-12-31').localeCompare(b.relaunchDate || '9999-12-31'));
            } else {
                const activeKpis = getActiveKpiFilters();
                tableData = filterDataByKpis(dataForPeriod, activeKpis);
            }

            updateKPIs(dataForPeriod, filterStartDate, filterEndDate); 
            updateTable(tableData);
            updateChart(dataForPeriod, filterStartDate, filterEndDate, annotationsData); 
            const totalWaiting = currentData.filter(item => item.status === 'Waiting').length;
            safeSet('kpiWaitingCount', totalWaiting);
        }

        async function fetchDataAndDisplay() {
             if (!db || !appId) { displayError("DB non prête."); return; }
             const tableBody = document.getElementById('detailsTableBody');
             tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-400">Chargement...</td></tr>`;
             resetKPIs();
             try {
                 const collectionPath = `artifacts/${appId}/public/data/r1_closings`; const querySnapshot = await getDocs(query(collection(db, collectionPath))); currentData = [];
                 querySnapshot.forEach((doc) => { currentData.push({ id: doc.id, ...doc.data() }); });
                 
                 currentData.sort((a, b) => { 
                     const dtA = `${a.prospectDate||'0000-00-00'}T${a.prospectTime||'00:00'}`; 
                     const dtB = `${b.prospectDate||'0000-00-00'}T${b.prospectTime||'00:00'}`; 
                     return dtB.localeCompare(dtA); 
                 });

                 const annotationsCollectionPath = `artifacts/${appId}/public/data/chart_annotations`;
                 const annotationsSnapshot = await getDocs(query(collection(db, annotationsCollectionPath)));
                 annotationsData = annotationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 
                 attachListeners();
                 setupKpiCardToggles(); 
                 setupFiltersAndLoad();
                 loadKpiSettings(); 
                 await fetchAndDisplaySlidingKPIs(currentData); 
                 renderReliabilityGauge(); 
                 renderDecisionEngine(); // Lance l'analyse du moteur de décision

             } catch (error) { 
                 console.error("Erreur fetch Firestore:", error); 
                 displayError("Erreur chargement données."); 
                 if (tableBody) tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-red-400">Erreur chargement.</td></tr>`; 
             }
         }

        // --- Decision Engine Logic ---
        function renderDecisionEngine() {
            // 1. Définir le début du cycle : STRICTEMENT BASÉ SUR LA DERNIÈRE ANNOTATION
            const sortedAnnotations = [...annotationsData].sort((a, b) => new Date(b.date) - new Date(a.date));
            const lastAnnotation = sortedAnnotations[0];
            
            let cycleStartDate;
            let cycleLabel;

            if (lastAnnotation && lastAnnotation.date) {
                cycleStartDate = parseDateString(lastAnnotation.date);
                const d = new Date(lastAnnotation.date);
                cycleLabel = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' });
            } else {
                // Fallback uniquement si aucune annotation n'est trouvée (Nouvel utilisateur)
                // On garde le 25 Nov comme "Date Zéro" historique du business model
                cycleStartDate = new Date(Date.UTC(2024, 10, 25)); 
                cycleLabel = "25/11/24 (Défaut - Ajoutez une ligne rouge)";
            }

            safeSet('decisionDate', new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }));
            safeSet('lastAnnotationDateDisplay', cycleLabel);
            
            // Mise à jour du titre pour refléter la source de données
            const reliabilityLabel = document.getElementById('reliabilityLabel');
            if(reliabilityLabel) reliabilityLabel.innerHTML = `Depuis Maj Tunnel: <span class="text-white font-bold">${cycleLabel}</span>`;


            // 2. Calculer Stock Total (QCPA Total)
            // On ne prend que les R1 effectués APRÈS ou LE JOUR de la dernière annotation
            const r1Stock = currentData.filter(d => 
                d.isR1Completed === true && 
                parseDateString(d.prospectDate) >= cycleStartDate
            ).length;

            // 3. Calculer Flux Récent (QCPA 14j)
            const today = new Date();
            const fourteenDaysAgo = new Date(today);
            fourteenDaysAgo.setDate(today.getDate() - 14);
            // On remet les heures à 0 pour comparaison stricte de date
            fourteenDaysAgo.setHours(0,0,0,0);

            const r1Flow14d = currentData.filter(d => {
                const pDate = parseDateString(d.prospectDate);
                return d.isR1Completed === true && pDate >= fourteenDaysAgo;
            }).length;

            const weeklyAverage = r1Flow14d / 2;

            // 4. Update DOM Elements (Chiffres)
            safeSet('deReliabilityValue', r1Stock);
            const reliabilityPercent = Math.min((r1Stock / 30) * 100, 100).toFixed(0);
            safeSet('deReliabilityPercent', `(${reliabilityPercent}%)`);
            
            const relStatusEl = document.getElementById('deReliabilityStatus');
            if(r1Stock >= 30) {
                relStatusEl.textContent = "FIABLE";
                relStatusEl.className = "px-2 py-1 bg-green-900/50 text-green-400 text-xs font-bold rounded border border-green-900";
            } else {
                relStatusEl.textContent = "NON FIABLE";
                relStatusEl.className = "px-2 py-1 bg-slate-800 text-gray-400 text-xs font-bold rounded";
            }

            safeSet('deThroughputValue', weeklyAverage.toFixed(1));
            
            // 5. Update Gauge Bar
            const barEl = document.getElementById('deThroughputBar');
            // Scale: 0 to 4+. 
            // 1.5 is 37.5% width. 3.0 is 75% width. 4.0 is 100% width.
            const barPercentage = Math.min((weeklyAverage / 4) * 100, 100);
            if(barEl) barEl.style.width = `${barPercentage}%`;

            // 6. MATRICE DE DECISION (Le Cerveau)
            const container = document.getElementById('deDirectiveContainer');
            const mainMsg = document.getElementById('deMainMessage');
            const subTitle = document.getElementById('deSubtitle');
            const actionOrder = document.getElementById('deActionOrder');
            const throughputStatus = document.getElementById('deThroughputStatus');

            // Reset Styles
            container.className = "rounded-lg p-5 flex flex-col justify-center border-l-4 transition-colors duration-300";

            if (r1Stock >= 30) {
                // CAS D : DATA VALIDÉE
                container.classList.add('bg-green-900/20', 'border-green-500');
                mainMsg.innerHTML = "🚀 DATA VALIDÉE :<br>PHASE DE SCALING ACTIVÉE.";
                mainMsg.className = "text-xl md:text-2xl font-black text-green-400 leading-tight mb-2";
                subTitle.textContent = "Vos statistiques sont désormais mathématiquement fiables.";
                actionOrder.textContent = "Vérifiez le ROAS. Si positif, doublez progressivement le budget pub. Le système est solide.";
                
                throughputStatus.textContent = "OPTIMAL";
                throughputStatus.className = "px-2 py-1 bg-green-900/50 text-green-400 text-xs font-bold rounded border border-green-900";
            } 
            else if (weeklyAverage < 1.5) {
                // CAS A : ALERTE ROUGE
                container.classList.add('bg-red-900/20', 'border-red-600');
                mainMsg.innerHTML = "🛑 ALERTE ROUGE :<br>INTERVENTION REQUISE IMMÉDIATE.";
                mainMsg.className = "text-xl md:text-2xl font-black text-red-500 leading-tight mb-2";
                subTitle.textContent = "Le débit est critique. Risque financier avéré.";
                actionOrder.textContent = "Augmenter le budget pub de 20% OU desserrer le filtre Calendly (enlever une friction) dès demain matin.";

                throughputStatus.textContent = "CRITIQUE";
                throughputStatus.className = "px-2 py-1 bg-red-900/50 text-red-400 text-xs font-bold rounded border border-red-900";
            }
            else if (weeklyAverage < 3.0) {
                // CAS B : ALERTE ORANGE
                container.classList.add('bg-orange-900/20', 'border-orange-500');
                mainMsg.innerHTML = "⚠️ ALERTE ORANGE :<br>PATIENCE VIGILANTE.";
                mainMsg.className = "text-xl md:text-2xl font-black text-orange-400 leading-tight mb-2";
                subTitle.textContent = "Le système est lent mais fonctionnel. Ne pas sur-réagir.";
                actionOrder.textContent = "INTERDICTION DE TOUCHER AU TUNNEL OU AUX PUBS. Action autorisée uniquement sur le mail marketing (relance base) pour tenter de passer en vert.";

                throughputStatus.textContent = "SOUS-RÉGIME";
                throughputStatus.className = "px-2 py-1 bg-orange-900/50 text-orange-400 text-xs font-bold rounded border border-orange-900";
            }
            else {
                // CAS C : FEU VERT (Mais pas encore fiable)
                container.classList.add('bg-emerald-900/20', 'border-emerald-500');
                mainMsg.innerHTML = "🟢 FEU VERT :<br>DORMEZ TRANQUILLE.";
                mainMsg.className = "text-xl md:text-2xl font-black text-emerald-400 leading-tight mb-2";
                subTitle.textContent = "Tout fonctionne parfaitement. Le business est en bonne santé.";
                actionOrder.textContent = "NE RIEN FAIRE. Laissez la jauge de fiabilité se remplir. Profitez de votre journée.";

                throughputStatus.textContent = "CROISIÈRE";
                throughputStatus.className = "px-2 py-1 bg-emerald-900/50 text-emerald-400 text-xs font-bold rounded border border-emerald-900";
            }
        }

        // --- Reliability Gauge Logic (Old Circular Gauge - Simplified) ---
        function renderReliabilityGauge() {
            // Cette fonction ne sert plus qu'à afficher le petit widget en haut à droite
            // Le calcul principal se fait dans renderDecisionEngine
            // On veut juste que le petit widget affiche la MEME CHOSE que le gros moteur
            const sortedAnnotations = [...annotationsData].sort((a, b) => new Date(b.date) - new Date(a.date));
            const lastAnnotation = sortedAnnotations[0];
            
            let cycleStartDate = new Date(Date.UTC(2024, 10, 25)); 
            if (lastAnnotation && lastAnnotation.date) {
                cycleStartDate = parseDateString(lastAnnotation.date);
            }
            
            const count = currentData.filter(d => 
                d.isR1Completed === true && 
                parseDateString(d.prospectDate) >= cycleStartDate
            ).length;

            safeSet('reliabilityCount', count);
            
            const ctx = document.getElementById('reliabilityChart');
            if (!ctx) return;
            
            const target = 30;
            const percentage = Math.min((count / target) * 100, 100);
            const remaining = 100 - percentage;
            
            let color = '#2dd4bf'; // Default Teal
            if (count >= target) color = '#22c55e'; // Green
            else if (count < 10) color = '#f97316'; // Orange

            if (reliabilityChartInstance) { reliabilityChartInstance.destroy(); }
            
            reliabilityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['R1 Faits', 'Restant'],
                    datasets: [{
                        data: [percentage, remaining],
                        backgroundColor: [color, 'rgba(51, 65, 85, 0.5)'], // slate-700
                        borderWidth: 0,
                        cutout: '85%', // Thickness
                        circumference: 360,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }
        
        async function fetchAndDisplaySlidingKPIs(data) {
            if (!data) { console.warn("J-180: Données non prêtes."); return; }
            const today = new Date(); const endDate = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999)); let startDate = new Date(endDate); startDate.setDate(startDate.getDate() - 180); startDate.setUTCHours(0, 0, 0, 0);
            try {
                 const slidingData = data.filter(item => { const iRD = parseDateString(item.prospectDate); return iRD && iRD >= startDate && iRD <= endDate; });
                 const planned = slidingData.length;
                 const completed = slidingData.filter(item => item.isR1Completed === true).length;
                 const noShowR1 = slidingData.filter(item => item.status === 'No Show R1').length;
                 const closed = slidingData.filter(item => item.isClosed === true).length;
                 let cash = 0;
                 slidingData.forEach(item => {
                     if (item.isClosed === true) { cash += Number(item.amountCollected) || 0; }
                 });

                 const convRate = completed > 0 ? ((closed / completed) * 100).toFixed(0) : 0;
                 safeSet('kpi-180-planned', planned); safeSet('kpi-180-completed', completed); safeSet('kpi-180-noshow-r1', `${noShowR1} (${(planned > 0 ? (noShowR1/planned*100).toFixed(0) : 0)}%)`); safeSet('kpi-180-closed', closed); safeSet('kpi-180-conv-rate', `${convRate}%`); safeSet('kpi-180-cash', `${cash.toLocaleString('fr-FR')}€`);
            } catch(e) { console.error("Erreur calcul J-180:", e); safeSet('kpi-180-planned', 'Err'); }
        }
        
        function updateKPIs(dataForPeriod, filterStart, filterEnd) {
            const r1Planned = dataForPeriod.length;
            const r1NoShow = dataForPeriod.filter(p => p.status === 'No Show R1').length;
            const disqualifiedCount = dataForPeriod.filter(p => p.status === 'Disqualified').length;
            const r1Completed = dataForPeriod.filter(p => p.isR1Completed === true).length;
            const r2Planned = dataForPeriod.filter(p => p.isR2Completed === true || p.status === 'No Show R2').length;
            const r2NoShow = dataForPeriod.filter(p => p.status === 'No Show R2').length;
            const closedCountForCohort = dataForPeriod.filter(p => p.isClosed === true).length;

            const closedInPeriod = currentData.filter(p => {
                const closingDate = parseDateString(p.closingDate);
                return p.isClosed === true && closingDate && closingDate >= filterStart && closingDate <= filterEnd;
            });
            const closedCountForKPI = closedInPeriod.length;

            const noShowR1Rate = r1Planned > 0 ? (r1NoShow / r1Planned * 100) : 0;
            const noShowR2Rate = r2Planned > 0 ? (r2NoShow / r2Planned * 100) : 0;
            const r1ToR2Rate = r1Completed > 0 ? (r2Planned / r1Completed * 100) : 0;
            const r2Completed = r2Planned - r2NoShow;
            const r2ToClosedRate = r2Completed > 0 ? (closedCountForCohort / r2Completed * 100) : 0;
            const r1PlanToClosedRate = r1Planned > 0 ? (closedCountForCohort / r1Planned * 100) : 0;

            let cashCollectedInPeriod = 0;
            currentData.forEach(item => {
                if (item.isClosed === true) {
                    const pT = item.paymentType || 'unique';
                    const tA = Number(item.amountCollected) || 0;
                    if (pT === 'unique') {
                        const paymentDate = parseDateString(item.closingDate);
                        if (paymentDate && paymentDate >= filterStart && paymentDate <= filterEnd) {
                            cashCollectedInPeriod += tA;
                        }
                    } else if (pT === 'installments') {
                        const iA = Number(item.installmentAmount) || 0;
                        const nI = parseInt(item.numberOfInstallments) || 0;
                        const fPD = parseDateString(item.startDateOfPayment);
                        if (iA > 0 && nI > 0 && fPD) {
                            for (let i = 0; i < nI; i++) {
                                const pD = addMonths(fPD, i);
                                if (pD >= filterStart && pD <= filterEnd) {
                                    cashCollectedInPeriod += iA;
                                }
                            }
                        }
                    }
                }
            });

            safeSet('kpiR1Planned', r1Planned);
            safeSet('kpiR1NoShowRate', `${noShowR1Rate.toFixed(1)}%`);
            safeSet('kpiR1NoShowCount', `(${r1NoShow})`);
            safeSet('kpiDisqualifiedCount', disqualifiedCount);
            safeSet('kpiR1Completed', r1Completed);
            safeSet('kpiR2Count', r2Planned);
            safeSet('kpiR2NoShowRate', `${noShowR2Rate.toFixed(1)}%`);
            safeSet('kpiR2NoShowCount', `(${r2NoShow})`);
            safeSet('kpiClosingCount', closedCountForKPI);
            safeSet('kpiR1toR2Rate', `${r1ToR2Rate.toFixed(1)}%`);
            safeSet('kpiR1toR2Count', `(${r2Planned})`);
            safeSet('kpiR2toClosedRate', `${r2ToClosedRate.toFixed(1)}%`);
            safeSet('kpiR2toClosedCount', `(${closedCountForCohort})`);
            safeSet('kpiR1PlanToClosedRate', `${r1PlanToClosedRate.toFixed(1)}%`);
            safeSet('kpiR1PlanToClosedCount', `(${closedCountForCohort})`);
            safeSet('kpiCashCollected', `${cashCollectedInPeriod.toLocaleString('fr-FR')}€`);

            updateTargetColor('kpi-target-r1-noshow', noShowR1Rate);
            updateTargetColor('kpi-target-r1-to-r2', r1ToR2Rate);
            updateTargetColor('kpi-target-r2-noshow', noShowR2Rate);
            updateTargetColor('kpi-target-r1plan-to-closed', r1PlanToClosedRate);
            updateTargetColor('kpi-target-r2-to-closed', r2ToClosedRate);
        }
        
        function updateChart(dataForChart, filterStart, filterEnd, annotationsData) {
            const ctx = document.getElementById('mainChart');
            if (!ctx) return;
        
            const dailyData = {};
            let currentDate = new Date(filterStart);
            const createMetric = () => ({ count: 0, names: [] });

            while (currentDate <= filterEnd) {
                const dateString = getISODate(currentDate);
                dailyData[dateString] = {
                    r1_planned: createMetric(),
                    r1_noshow: createMetric(),
                    disqualified: createMetric(),
                    r1: createMetric(),
                    r2_count: createMetric(),
                    r2_noshow: createMetric(),
                    closed: createMetric(),
                    cash: { count: 0, names: [] }
                };
                currentDate.setDate(currentDate.getDate() + 1);
            }
        
            dataForChart.forEach(item => {
                const itemR1DateStr = item.prospectDate;
                const prospectName = item.prospectName || 'N/A';
                if (dailyData[itemR1DateStr]) {
                    dailyData[itemR1DateStr].r1_planned.count++;
                    dailyData[itemR1DateStr].r1_planned.names.push(prospectName);

                    if (item.status === 'No Show R1') {
                        dailyData[itemR1DateStr].r1_noshow.count++;
                        dailyData[itemR1DateStr].r1_noshow.names.push(prospectName);
                    }
                    if (item.status === 'Disqualified') {
                        dailyData[itemR1DateStr].disqualified.count++;
                        dailyData[itemR1DateStr].disqualified.names.push(prospectName);
                    }
                    if (item.isR1Completed === true) {
                        dailyData[itemR1DateStr].r1.count++;
                        dailyData[itemR1DateStr].r1.names.push(prospectName);
                    }
                    if (item.isR2Completed === true || item.status === 'No Show R2') {
                        dailyData[itemR1DateStr].r2_count.count++;
                        dailyData[itemR1DateStr].r2_count.names.push(prospectName);
                    }
                    if (item.status === 'No Show R2') {
                        dailyData[itemR1DateStr].r2_noshow.count++;
                        dailyData[itemR1DateStr].r2_noshow.names.push(prospectName);
                    }
                }
            });
        
            currentData.forEach(item => {
                const prospectName = item.prospectName || 'N/A';
                if (item.isClosed === true) {
                    const closingDate = parseDateString(item.closingDate);
                    if (closingDate && closingDate >= filterStart && closingDate <= filterEnd) {
                        const closingDateStr = getISODate(closingDate);
                        if (dailyData[closingDateStr]) {
                            dailyData[closingDateStr].closed.count++;
                            dailyData[closingDateStr].closed.names.push(prospectName);
                        }
                    }
        
                    const pT = item.paymentType || 'unique';
                    if (pT === 'unique') {
                        const pD = closingDate; 
                        const amt = Number(item.amountCollected) || 0;
                        if (pD && pD >= filterStart && pD <= filterEnd) {
                            const cashDateStr = getISODate(pD);
                            if (dailyData[cashDateStr] && amt > 0) {
                                dailyData[cashDateStr].cash.count += amt;
                                dailyData[cashDateStr].cash.names.push(`${prospectName} (${amt.toLocaleString('fr-FR')}€)`);
                            }
                        }
                    } else if (pT === 'installments') {
                        const pD = parseDateString(item.startDateOfPayment);
                        const amt = Number(item.installmentAmount) || 0;
                        const nI = parseInt(item.numberOfInstallments) || 0;
                        if (pD && amt > 0 && nI > 0) {
                            for (let i = 0; i < nI; i++) {
                                const cPD = addMonths(pD, i);
                                if (cPD >= filterStart && cPD <= filterEnd) {
                                    const cPDS = getISODate(cPD);
                                    if (dailyData[cPDS]) {
                                        dailyData[cPDS].cash.count += amt;
                                        dailyData[cPDS].cash.names.push(`${prospectName} (${amt.toLocaleString('fr-FR')}€)`);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        
            const labels = Object.keys(dailyData).sort();
            const r1PlannedData = labels.map(date => dailyData[date].r1_planned.count);
            const r1NoShowData = labels.map(date => dailyData[date].r1_noshow.count);
            const disqualifiedData = labels.map(date => dailyData[date].disqualified.count);
            const r1Data = labels.map(date => dailyData[date].r1.count);
            const r2CountData = labels.map(date => dailyData[date].r2_count.count);
            const r2NoShowData = labels.map(date => dailyData[date].r2_noshow.count);
            const closedData = labels.map(date => dailyData[date].closed.count);
            const cashData = labels.map(date => dailyData[date].cash.count);
        
            const chartAnnotations = (annotationsData || [])
                .filter(anno => {
                    const annoDate = parseDateString(anno.date);
                    return annoDate && annoDate >= filterStart && annoDate <= filterEnd;
                })
                .map(anno => ({
                    id: anno.id,
                    type: 'line',
                    scaleID: 'x',
                    value: anno.date,
                    borderColor: 'rgba(239, 68, 68, 0.7)',
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                        content: anno.comment.split('\n'),
                        display: false,
                        position: 'start',
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        color: '#e2e8f0',
                        font: { size: 12 },
                        padding: 8,
                        borderRadius: 4,
                        yAdjust: -15,
                    },
                    enter(ctx) {
                        ctx.chart.canvas.style.cursor = 'pointer';
                        ctx.element.label.options.display = true;
                        return true;
                    },
                    leave(ctx) {
                        ctx.chart.canvas.style.cursor = 'default';
                        ctx.element.label.options.display = false;
                        return true;
                    },
                    click(ctx) {
                        const annotationId = ctx.element.options.id;
                        const comment = ctx.element.label.options.content.join('\n');
                        if (annotationId && confirm(`Supprimer l'événement "${comment}" ?`)) {
                            deleteAnnotation(annotationId);
                        }
                    }
            }));

            if (mainChartInstance) { mainChartInstance.destroy(); }
            const isHidden = (id) => { const card = document.getElementById(id); return card ? !card.classList.contains('kpi-chart-active') : true; };
            mainChartInstance = new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [ { label: 'R1 Planifiés', data: r1PlannedData, borderColor: 'rgba(245, 158, 11, 1)', backgroundColor: 'rgba(245, 158, 11, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-r1-planned') }, { label: 'No Show R1', data: r1NoShowData, borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-r1-noshow') }, { label: 'Disqualifiés', data: disqualifiedData, borderColor: 'rgba(249, 115, 22, 1)', backgroundColor: 'rgba(249, 115, 22, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-disqualified') }, { label: 'R1 Effectués', data: r1Data, borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-r1-completed') }, { label: 'R2 Planifiés', data: r2CountData, borderColor: 'rgba(168, 85, 247, 1)', backgroundColor: 'rgba(168, 85, 247, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-r2-count') }, { label: 'No Show R2', data: r2NoShowData, borderColor: 'rgba(185, 28, 28, 1)', backgroundColor: 'rgba(185, 28, 28, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-r2-noshow') }, { label: 'Closings', data: closedData, borderColor: 'rgba(34, 197, 94, 1)', backgroundColor: 'rgba(34, 197, 94, 0.7)', tension: 0.1, yAxisID: 'yCount', hidden: isHidden('kpi-card-closing') }, { label: 'Cash Période (€)', data: cashData, borderColor: 'rgba(20, 184, 166, 1)', backgroundColor: 'rgba(20, 184, 166, 0.7)', tension: 0.1, yAxisID: 'yCash', hidden: isHidden('kpi-card-cash') }, ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, onClick: (event, elements, chart) => { if (chart) { const dateIndex = chart.scales.x.getValueForPixel(event.x); const dateString = chart.data.labels[dateIndex]; if (dateString) { openAnnotationModal(dateString); } } }, scales: { x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, yCount: { type: 'linear', position: 'left', beginAtZero: true, ticks: { color: '#9ca3af', stepSize: 1 }, grid: { color: '#374151' }, title: { display: true, text: 'Nombre', color: '#9ca3af' } }, yCash: { type: 'linear', position: 'right', beginAtZero: true, ticks: { color: '#9ca3af', callback: (value) => `${value}€` }, grid: { drawOnChartArea: false }, title: { display: true, text: 'Montant (€)', color: '#9ca3af' } } }, plugins: { annotation: { annotations: chartAnnotations }, legend: { display: false }, tooltip: { titleFont: { size: 14 }, bodyFont: { size: 12 }, footerFont: { size: 10, weight: 'normal' }, footerColor: '#cbd5e1', footerSpacing: 4, callbacks: { footer: function(tooltipItems) { const dateIndex = tooltipItems[0]?.dataIndex; if (dateIndex === undefined) return ''; const date = labels[dateIndex]; if (!date || !dailyData[date]) return ''; const namesToShow = []; tooltipItems.forEach(item => { if (item.dataset.hidden || item.parsed.y === 0) return; const datasetLabel = item.dataset.label; let prospectList = []; switch(datasetLabel) { case 'R1 Planifiés': prospectList = dailyData[date].r1_planned.names; break; case 'No Show R1': prospectList = dailyData[date].r1_noshow.names; break; case 'Disqualifiés': prospectList = dailyData[date].disqualified.names; break; case 'R1 Effectués': prospectList = dailyData[date].r1.names; break; case 'R2 Planifiés': prospectList = dailyData[date].r2_count.names; break; case 'No Show R2': prospectList = dailyData[date].r2_noshow.names; break; case 'Closings': prospectList = dailyData[date].closed.names; break; case 'Cash Période (€)': prospectList = dailyData[date].cash.names; break; } if (prospectList && prospectList.length > 0) { namesToShow.push(...prospectList); } }); const uniqueNames = [...new Set(namesToShow)]; if (uniqueNames.length > 0) { return ['', 'Personnes concernées:', ...uniqueNames.map(name => `• ${name}`)]; } return ''; } } } } } }); 
            updateChartVisibility();
        }
        
        function updateChartVisibility() { if (!mainChartInstance) return; try { const isHidden = (id) => { const card = document.getElementById(id); return card ? !card.classList.contains('kpi-chart-active') : true; }; mainChartInstance.data.datasets[0].hidden = isHidden('kpi-card-r1-planned'); mainChartInstance.data.datasets[1].hidden = isHidden('kpi-card-r1-noshow'); mainChartInstance.data.datasets[2].hidden = isHidden('kpi-card-disqualified'); mainChartInstance.data.datasets[3].hidden = isHidden('kpi-card-r1-completed'); mainChartInstance.data.datasets[4].hidden = isHidden('kpi-card-r2-count'); mainChartInstance.data.datasets[5].hidden = isHidden('kpi-card-r2-noshow'); mainChartInstance.data.datasets[6].hidden = isHidden('kpi-card-closing'); mainChartInstance.data.datasets[7].hidden = isHidden('kpi-card-cash'); mainChartInstance.update(); } catch (e) { console.error("Erreur MAJ visibilité graphique:", e); } }

        function deactivateAllChartKpis() {
            document.querySelectorAll('.kpi-card-toggle').forEach(card => {
                if (card.id !== 'kpi-card-waiting') {
                    card.classList.remove('kpi-chart-active');
                    card.classList.add('opacity-60');
                }
            });
        }

        function setupKpiCardToggles() {
            const kpiToggleLogic = (e) => {
                const card = e.currentTarget;
                const cardId = card.id;
                const dateShortcutsContainer = document.getElementById('dateShortcuts');

                if (cardId === 'kpi-card-waiting') {
                    const wasActive = card.classList.contains('kpi-chart-active');
                    if (wasActive) return;

                    deactivateAllChartKpis();

                    card.classList.add('kpi-chart-active');
                    card.classList.remove('opacity-60');
                    
                    currentViewMode = 'waiting';
                    dateShortcutsContainer.querySelectorAll('button').forEach(b => b.disabled = true);
                    dateShortcutsContainer.querySelectorAll('button.active').forEach(b => b.classList.remove('active'));
                    
                    renderFilteredData();
                    updateChartVisibility();

                } else {
                    if (currentViewMode === 'waiting') {
                        currentViewMode = 'period';
                        const waitingCard = document.getElementById('kpi-card-waiting');
                        if (waitingCard) {
                            waitingCard.classList.remove('kpi-chart-active');
                            waitingCard.classList.add('opacity-60');
                        }
                        dateShortcutsContainer.querySelectorAll('button').forEach(b => b.disabled = false);
                    }
                    
                    card.classList.toggle('kpi-chart-active');
                    card.classList.toggle('opacity-60');
                    
                    renderFilteredData();
                    updateChartVisibility();
                }
            };

            document.querySelectorAll('.kpi-card-toggle').forEach(card => {
                const id = card.id;
                const defaultActive = ['kpi-card-r1-planned'];
                if (defaultActive.includes(id)) {
                    card.classList.add('kpi-chart-active');
                    card.classList.remove('opacity-60');
                } else {
                    card.classList.remove('kpi-chart-active');
                    card.classList.add('opacity-60');
                }
                card.addEventListener('click', kpiToggleLogic);
            });
        }
        
        function updateTable(data) {
             const tB=document.getElementById('detailsTableBody');
             if(!tB) return;
             if(data.length===0){tB.innerHTML=`<tr><td colspan="10" class="text-center py-4 text-gray-400">Aucune donnée pour cette vue.</td></tr>`; return;}
             
             const finalStatusOptions = [
                { value: '', text: '---' }, // Default empty option
                { value: 'Waiting', text: 'En Attente' },
                { value: 'No Show R1', text: 'No Show R1' },
                { value: 'No Show R2', text: 'No Show R2' },
                { value: 'Disqualified', text: 'Disqualifié' },
                { value: 'Lost', text: 'Perdu' }
             ];

             tB.innerHTML = data.map(i => {
                 const pA_text = i.comments || '';
                 let pA_display;
                 if (pA_text) {
                     const escaped_text = pA_text.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                     pA_display = `<span class="tooltip-container text-sky-400 cursor-help">Voir<span class="tooltip-text">${escaped_text}</span></span>`;
                 } else {
                     pA_display = '<span class="text-gray-400">-</span>';
                 }

                 const tA = Number(i.amountCollected) || 0;
                 const pN = i.prospectName || 'N/A'; const ePn = pN.replace(/"/g,'&quot;');
                 const formattedR1Date = formatDateToDDMM(i.prospectDate);
                 const dTD = `${formattedR1Date} ${i.prospectTime?`<span class="text-xs text-gray-400">${i.prospectTime}</span>`:''}`;
                 
                 const prequalStatus = i.prequalStatus || 'none';
                 let prequalIcon, prequalTooltip, prequalBtnClasses = 'prequal-status-btn p-0 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 inline-flex items-center justify-center border border-slate-600 hover:border-slate-500';
                 switch (prequalStatus) {
                    case 'sent':
                        prequalIcon = `<svg class="w-4 h-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;
                        prequalBtnClasses += ' hover:bg-blue-900/50 focus:ring-blue-500';
                        prequalTooltip = 'Message envoyé. Cliquer pour marquer comme "Confirmé".';
                        break;
                    case 'confirmed':
                        prequalIcon = `<svg class="w-4 h-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>`;
                        prequalBtnClasses += ' hover:bg-green-900/50 focus:ring-green-500';
                        prequalTooltip = 'Pré-qualifié. Cliquer pour marquer comme "Rejeté".';
                        break;
                    case 'rejected':
                        prequalIcon = `<svg class="w-4 h-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                        prequalBtnClasses += ' hover:bg-red-900/50 focus:ring-red-500';
                        prequalTooltip = 'Rejeté. Cliquer pour réinitialiser.';
                        break;
                    default:
                        prequalIcon = `<svg class="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01"></path></svg>`;
                        prequalBtnClasses += ' hover:bg-slate-700 focus:ring-slate-500';
                        prequalTooltip = 'Non envoyé. Cliquer pour marquer comme "Envoyé".';
                        break;
                 }
                 const prequalCellHTML = `<div class="tooltip-container"><button class="${prequalBtnClasses}" data-doc-id="${i.id}" data-status="${prequalStatus}">${prequalIcon}</button><span class="tooltip-text !w-60 !-ml-32">${prequalTooltip}</span></div>`;

                 let detailsButton, editButton;
                 if (i.status === 'R1 Scheduled') {
                     detailsButton = `<button data-doc-id="${i.id}" data-prospect-name="${ePn}" class="start-r1-prompt-btn text-yellow-400 hover:text-yellow-300 text-xs font-medium px-1.5 py-0.5 rounded hover:bg-slate-700 transition-colors whitespace-nowrap">Démarrer R1</button>`;
                 } else {
                     detailsButton = `<a href="main.html?docId=${i.id}" class="details-btn text-blue-400 hover:text-blue-300 text-xs font-medium px-1.5 py-0 rounded hover:bg-slate-700 transition-colors">Détails</a>`;
                 }
                 editButton = `<button data-doc-id="${i.id}" class="edit-btn text-green-400 hover:text-green-300 text-xs font-medium px-1.5 py-0 rounded hover:bg-slate-700 transition-colors">Modifier</button>`;
                 
                 const isR1Done = i.isR1Completed === true;
                 const isR2Done = i.isR2Completed === true;
                 const isClosed = i.isClosed === true;

                 const r1CheckboxHTML = `<input type="checkbox" class="custom-checkbox" data-doc-id="${i.id}" data-action="r1_fait" ${isR1Done ? 'checked' : ''}>`;
                 const r2CheckboxHTML = `<input type="checkbox" class="custom-checkbox" data-doc-id="${i.id}" data-action="r2_prevu" ${isR2Done ? 'checked' : ''}>`;
                 const closeCheckboxHTML = `<input type="checkbox" class="custom-checkbox" data-doc-id="${i.id}" data-action="close" ${isClosed ? 'checked' : ''}>`;
                 
                 const exceptionStatuses = ['Waiting', 'No Show R1', 'No Show R2', 'Disqualified', 'Lost'];
                 const currentStatusValue = (i.status && exceptionStatuses.includes(i.status)) ? i.status : '';

                 const finalStatusSelectHTML = `
                    <select class="status-select" data-doc-id="${i.id}" data-original-status="${currentStatusValue}">
                        ${finalStatusOptions.map(opt => `<option value="${opt.value}" ${currentStatusValue === opt.value ? 'selected' : ''}>${opt.text}</option>`).join('')}
                    </select>
                 `;

                 return `<tr>
                     <td class="whitespace-nowrap text-sm text-gray-200">${dTD}</td>
                     <td class="text-sm text-gray-200 truncate max-w-xs">${pN}</td>
                     <td class="whitespace-nowrap text-sm text-center">${prequalCellHTML}</td>
                     <td class="text-center">${r1CheckboxHTML}</td>
                     <td class="text-center">${r2CheckboxHTML}</td>
                     <td class="text-center">${closeCheckboxHTML}</td>
                     <td class="whitespace-nowrap text-sm">${finalStatusSelectHTML}</td>
                     <td class="whitespace-nowrap text-sm">${pA_display}</td>
                     <td class="whitespace-nowrap text-sm text-gray-200 text-right">${tA>0?tA.toLocaleString('fr-FR')+'€':'-'}</td>
                     <td class="whitespace-nowrap text-sm text-center space-x-2">${detailsButton} ${editButton} <button data-doc-id="${i.id}" data-prospect-name="${ePn}" class="delete-btn text-red-400 hover:text-red-300 text-xs font-medium px-1.5 py-0 rounded hover:bg-slate-700 transition-colors">Suppr.</button> </td>
                 </tr>`;
             }).join('');
         }

        function getStatusClass(status) { switch(status){ case 'R1 Scheduled': return 'status-scheduled'; case 'Waiting': return 'status-waiting'; case 'No Show R1': return 'status-noshow-r1'; case 'No Show R2': return 'status-noshow-r2'; case 'Disqualified': return 'status-disqualified'; case 'R1 Completed':return 'status-r1';case 'R2 Scheduled':return 'status-r2';case 'Closed':return 'status-closed';case 'Lost':return 'status-lost';default:return 'status-other';} }
        
        function resetKPIs() {
            const kpiIds = ['kpiR1Planned', 'kpiR1NoShowCount', 'kpiR1Completed', 'kpiR2Count', 'kpiR2NoShowCount', 'kpiClosingCount', 'kpiR1toR2Count', 'kpiR2toClosedCount', 'kpiR1PlanToClosedCount', 'kpiDisqualifiedCount'];
            kpiIds.forEach(id => safeSet(id, id.includes('Count') && !id.includes('kpiDisqualifiedCount') ? '(0)' : '0'));
            safeSet('kpiR1NoShowRate', '0%');
            safeSet('kpiR2NoShowRate', '0%');
            safeSet('kpiR1toR2Rate', '0%'); 
            safeSet('kpiR2toClosedRate', '0%');
            safeSet('kpiR1PlanToClosedRate', '0%');
            safeSet('kpiCashCollected', '0€');
            safeSet('kpiWaitingCount', '0');
        }
        
        // --- Navigation Mois & Filtres ---
        function navigateMonth(step) {
            const startDateInput = document.getElementById('startDate');
            if (!startDateInput.value) return;

            const currentStart = parseDateString(startDateInput.value);
            if (!currentStart) return;

            currentStart.setDate(1);
            
            const targetDate = new Date(currentStart);
            targetDate.setMonth(targetDate.getMonth() + step);

            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();

            const newStart = new Date(Date.UTC(year, month, 1));
            const newEnd = new Date(Date.UTC(year, month + 1, 0));

            document.getElementById('startDate').value = getISODate(newStart);
            document.getElementById('endDate').value = getISODate(newEnd);

            document.querySelectorAll('.date-shortcut').forEach(btn => btn.classList.remove('active'));
            const monthBtn = document.querySelector('button[data-days="month"]');
            if (monthBtn) monthBtn.classList.add('active');

            renderFilteredData();
            updateCurrentMonthLabel();
        }

        function setupFiltersAndLoad() {
            const s = document.getElementById('startDate'), e = document.getElementById('endDate');
            const shortcuts = document.getElementById('dateShortcuts');

            if (!s || !e || !shortcuts) return;

            function setDates(startDate, endDate) {
                s.value = getISODate(startDate);
                e.value = getISODate(endDate);
            }

            function handleShortcutClick(ev) {
                if (ev.target.tagName !== 'BUTTON' || ev.target.id === 'prevMonthBtn' || ev.target.id === 'nextMonthBtn') return;
                
                shortcuts.querySelectorAll('button:not(#prevMonthBtn):not(#nextMonthBtn)').forEach(btn => btn.classList.remove('active'));
                ev.target.classList.add('active');
                
                if (currentViewMode === 'waiting') {
                    currentViewMode = 'period';
                    const waitingCard = document.getElementById('kpi-card-waiting');
                    if(waitingCard) {
                        waitingCard.classList.remove('kpi-chart-active');
                        waitingCard.classList.add('opacity-60');
                    }
                    shortcuts.querySelectorAll('button').forEach(b => b.disabled = false);
                }

                const days = ev.target.dataset.days;
                const today = new Date();
                let startDate = new Date(today),
                    endDate = new Date(today);
                if (days === 'month') {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                } else {
                    const numDays = parseInt(days, 10);
                    if (numDays === 0) {
                        startDate.setDate(today.getDate());
                    } else {
                        startDate.setDate(today.getDate() - numDays + 1);
                    }
                }
                const sUTC = new Date(Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()));
                const eUTC = new Date(Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate()));
                setDates(sUTC, eUTC);
                updateCurrentMonthLabel();
                renderFilteredData();
            }
            shortcuts.addEventListener('click', handleShortcutClick);
            
            document.getElementById('prevMonthBtn').addEventListener('click', () => navigateMonth(-1));
            document.getElementById('nextMonthBtn').addEventListener('click', () => navigateMonth(1));

            function onDateChange() {
                shortcuts.querySelectorAll('button:not(#prevMonthBtn):not(#nextMonthBtn)').forEach(btn => btn.classList.remove('active'));
                if (s.value && e.value) {
                    renderFilteredData();
                    updateCurrentMonthLabel();
                }
            }

            s.addEventListener('change', onDateChange);
            e.addEventListener('change', onDateChange);

            const monthShortcut = shortcuts.querySelector('button[data-days="month"]');
            if (monthShortcut) monthShortcut.click();
        }

        function updateCurrentMonthLabel() {
            const sInput = document.getElementById('startDate');
            const mBtn = document.querySelector('button[data-days="month"]');
            if (sInput && sInput.value && mBtn) {
                const d = parseDateString(sInput.value);
                if (d) {
                    const dateForLabel = new Date(d.getFullYear(), d.getMonth(), 1);
                    const label = dateForLabel.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                    mBtn.textContent = label.charAt(0).toUpperCase() + label.slice(1);
                }
            }
        }
        
        function displayError(message, isError = false) { let d=document.getElementById('dashboardError');if(!d){d=document.createElement('div');d.id='dashboardError';d.className='fixed bottom-4 right-4 p-4 bg-red-800 text-white rounded-lg shadow-xl z-[60]';document.body.appendChild(d);} if (isError) { d.classList.remove('bg-green-600'); d.classList.add('bg-red-800'); } else { d.classList.remove('bg-red-800'); d.classList.add('bg-green-600'); } d.textContent=message;setTimeout(()=>d.remove(),3000); }
        
        // --- Settings Menu Logic ---
        function loadKpiSettings() {
            try {
                const savedSettings = localStorage.getItem('gia_kpi_settings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    kpiDefinitions.forEach(kpi => {
                        const card = document.getElementById(kpi.id);
                        if (card) {
                            if (settings[kpi.id] === false) {
                                card.classList.add('kpi-hidden-by-settings');
                            } else {
                                card.classList.remove('kpi-hidden-by-settings');
                            }
                        }
                    });
                }
            } catch (e) { console.error("Error loading settings", e); }
        }

        function saveKpiSettings() {
            const settings = {};
            kpiDefinitions.forEach(kpi => {
                const checkbox = document.getElementById(`setting-${kpi.id}`);
                if (checkbox) {
                    settings[kpi.id] = checkbox.checked;
                    const card = document.getElementById(kpi.id);
                    if (card) {
                        if (!checkbox.checked) card.classList.add('kpi-hidden-by-settings');
                        else card.classList.remove('kpi-hidden-by-settings');
                    }
                }
            });
            localStorage.setItem('gia_kpi_settings', JSON.stringify(settings));
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openSettingsModal() {
            const list = document.getElementById('kpiSettingsList');
            list.innerHTML = '';
            
            kpiDefinitions.forEach(kpi => {
                const card = document.getElementById(kpi.id);
                const isVisible = card ? !card.classList.contains('kpi-hidden-by-settings') : kpi.defaultVisible;
                
                const item = document.createElement('div');
                item.className = 'flex items-center p-2 bg-slate-700 rounded';
                item.innerHTML = `
                    <input type="checkbox" id="setting-${kpi.id}" ${isVisible ? 'checked' : ''} class="w-4 h-4 text-teal-600 rounded bg-slate-800 border-gray-600 focus:ring-teal-500 focus:ring-2">
                    <label for="setting-${kpi.id}" class="ml-2 text-sm font-medium text-gray-300 flex-grow cursor-pointer select-none">${kpi.label}</label>
                `;
                list.appendChild(item);
            });
            
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        // --- Standard Modal Logic ---
        const modalStatusSelect = document.getElementById('modalStatus');
        const cbR1 = document.getElementById('modalIsR1Completed');
        const cbR2 = document.getElementById('modalIsR2Completed');
        const cbClosed = document.getElementById('modalIsClosed');
        
        function updateModalCheckboxesLogic() {
            if (!cbR1 || !cbR2 || !cbClosed) return;
            if (cbClosed.checked || cbR2.checked) {
                cbR1.checked = true;
                cbR1.disabled = true;
            } else {
                cbR1.disabled = false;
            }
            if(cbClosed.checked) {
                cbR2.checked = true;
                cbR2.disabled = true;
            } else {
                cbR2.disabled = false;
            }

            const fieldsR2 = document.getElementById('modalR2Fields');
            const paymentDetailsContainer = document.getElementById('paymentDetailsContainer');
            const closingDateContainer = document.getElementById('modalClosingDateContainer');
            const closingDateInput = document.getElementById('modalClosingDate');

            if(fieldsR2) fieldsR2.classList.toggle('hidden', !cbR2.checked);
            if(paymentDetailsContainer) paymentDetailsContainer.classList.toggle('hidden', !cbClosed.checked);
            if(closingDateContainer) closingDateContainer.classList.toggle('hidden', !cbClosed.checked);

            if(cbClosed.checked && closingDateInput && !closingDateInput.value) {
                closingDateInput.value = getISODate(new Date());
            }
        }

        if(cbR1) cbR1.addEventListener('change', updateModalCheckboxesLogic);
        if(cbR2) cbR2.addEventListener('change', updateModalCheckboxesLogic);
        if(cbClosed) cbClosed.addEventListener('change', updateModalCheckboxesLogic);
        
        if(modalStatusSelect) modalStatusSelect.addEventListener('change', () => {
             const status = modalStatusSelect.value;
             const relaunchDateContainer = document.getElementById('modalRelaunchDateContainer');
             const statusContainer = document.getElementById('modalStatusContainer');
             if(!relaunchDateContainer || !statusContainer) return;
             
             const showRelaunch = status === 'Waiting';
             relaunchDateContainer.classList.toggle('hidden', !showRelaunch);
             statusContainer.classList.toggle('sm:col-span-2', !showRelaunch);
             
             const today = new Date(); const todayStr = getISODate(today); const todayTime = getHHMMTime(today);
             
             if (status === 'R1 Completed' && !cbR1.checked) { cbR1.checked = true; }
             if (status === 'R2 Scheduled' && !cbR2.checked) { cbR2.checked = true; }
             if (status === 'Closed' && !cbClosed.checked) { cbClosed.checked = true; }
             if (status === 'No Show R1') { cbR1.checked = false; }
             updateModalCheckboxesLogic();

             const dateR2Input = document.getElementById('modalProspectDateR2');
             if (status === 'R2 Scheduled' && dateR2Input && !dateR2Input.value) {
                 dateR2Input.value = todayStr;
                 document.getElementById('modalProspectTimeR2').value = todayTime;
             }
             const relaunchInput = document.getElementById('modalRelaunchDate');
             if (status === 'Waiting' && relaunchInput && !relaunchInput.value) {
                 relaunchInput.value = getISODateWithOffset(7);
             }
             const paymentDateInput = document.getElementById('modalStartDateOfPayment');
             if (status === 'Closed' && paymentDateInput && !paymentDateInput.value) {
                 paymentDateInput.value = todayStr;
             }
             const closingDateInput = document.getElementById('modalClosingDate');
             if (status === 'Closed' && closingDateInput && !closingDateInput.value) {
                closingDateInput.value = todayStr;
             }
        });
        
        function setupModalPaymentLogic(){
            const paymentTypeSelect = document.getElementById('modalPaymentType');
            const installmentsFieldsDiv = document.getElementById('installmentsFields');
            const amountCollectedInput = document.getElementById('modalAmountCollected');
            const installmentAmountInput = document.getElementById('modalInstallmentAmount');
            const numberOfInstallmentsInput = document.getElementById('modalNumberOfInstallments');
            if(!paymentTypeSelect) return;

            function calculateTotalAmount() { 
                if (paymentTypeSelect.value === 'installments') { 
                    const i = Number(installmentAmountInput.value) || 0; 
                    const n = parseInt(numberOfInstallmentsInput.value) || 0; 
                    if (i > 0 && n > 0) amountCollectedInput.value = i * n;
                }
            }
            if(installmentAmountInput) installmentAmountInput.addEventListener('input', calculateTotalAmount);
            if(numberOfInstallmentsInput) numberOfInstallmentsInput.addEventListener('input', calculateTotalAmount);
            paymentTypeSelect.addEventListener('change', () => { 
                if(installmentsFieldsDiv) installmentsFieldsDiv.classList.toggle('hidden', paymentTypeSelect.value !== 'installments'); 
                if (paymentTypeSelect.value === 'installments') calculateTotalAmount();
            });
        }
        setupModalPaymentLogic();

        function openEditModal(docId, options = {}) { 
             const pD=currentData.find(i=>i.id===docId); if(!pD)return; 
             document.getElementById('modalProspectName').textContent=pD.prospectName||'N/A'; 
             document.getElementById('modalDocId').value=docId; 
             
             if(cbR1) cbR1.disabled = false;
             if(cbR2) cbR2.disabled = false;

             const prospectDateInput = document.getElementById('modalProspectDate');
             const prospectTimeInput = document.getElementById('modalProspectTime');

             prospectDateInput.value = pD.prospectDate || ''; 
             prospectTimeInput.value = pD.prospectTime || ''; 
             prospectDateInput.readOnly = true;
             prospectTimeInput.readOnly = true;

             document.getElementById('modalProspectDateR2').value = pD.prospectDateR2 || ''; 
             document.getElementById('modalProspectTimeR2').value = pD.prospectTimeR2 || ''; 
             
             if(cbR1) cbR1.checked = pD.isR1Completed || false;
             if(cbR2) cbR2.checked = pD.isR2Completed || false;
             if(cbClosed) cbClosed.checked = pD.isClosed || false;
             document.getElementById('modalClosingDate').value = pD.closingDate || '';
             
             if (options.preCheck === 'r2_prevu' && cbR2) cbR2.checked = true;
             if (options.preCheck === 'close' && cbClosed) cbClosed.checked = true;

             updateModalCheckboxesLogic();
             
             const cS=pD.status||'R1 Scheduled'; 
             if (options.statusToSet) {
                if(modalStatusSelect) modalStatusSelect.value = options.statusToSet;
                modalStatusSelect.dispatchEvent(new Event('change'));
             } else {
                if(modalStatusSelect) modalStatusSelect.value = cS; 
             }
             
             document.getElementById('modalRelaunchDate').value = pD.relaunchDate || '';
             const statusContainer = document.getElementById('modalStatusContainer');
             const relaunchDateContainer = document.getElementById('modalRelaunchDateContainer');
             const showRelaunch = (options.statusToSet || cS) === 'Waiting'; 
             relaunchDateContainer.classList.toggle('hidden', !showRelaunch); 
             if(statusContainer) statusContainer.classList.toggle('sm:col-span-2', !showRelaunch);
             
             document.getElementById('modalNote').value = pD.comments || '';
             
             const pT=pD.paymentType||'unique'; 
             document.getElementById('modalPaymentType').value = pT; 
             document.getElementById('modalAmountCollected').value=pD.amountCollected||''; 
             document.getElementById('modalInstallmentAmount').value=pD.installmentAmount||''; 
             document.getElementById('modalNumberOfInstallments').value=pD.numberOfInstallments||''; 
             document.getElementById('modalStartDateOfPayment').value=pD.startDateOfPayment||''; 
             document.getElementById('installmentsFields').classList.toggle('hidden',pT!=='installments');
             document.getElementById('modalError').textContent='';
             document.getElementById('editModal').classList.remove('hidden'); 
        }
        function closeEditModal() { 
            const modal = document.getElementById('editModal'); 
            if(modal) {
                document.getElementById('modalProspectDate').readOnly = false;
                document.getElementById('modalProspectTime').readOnly = false;
                modal.classList.add('hidden'); 
            }
        }
        
        async function saveModalChanges() {
             const dId=document.getElementById('modalDocId').value; 
             const nS=modalStatusSelect.value; 
             const mE=document.getElementById('modalError'); 
             const sB=document.getElementById('modalSaveButton');
             if(!dId || !nS || !mE || !sB) return;
             
             const isR1 = cbR1.checked; const isR2 = cbR2.checked; const isClosed = cbClosed.checked;
             const originalProspect = currentData.find(item => item.id === dId);
             if (!originalProspect || !originalProspect.prospectDate) { mE.textContent = "Erreur: Impossible de trouver la date R1 originale."; return; }
             
             mE.textContent='';sB.disabled=true;sB.textContent='Sauvegarde...';
             
             try {
                 const cP=`artifacts/${appId}/public/data/r1_closings`; const dR=doc(db,cP,dId);
                 const dTU={
                     status:nS, 
                     isR1Completed: nS === 'No Show R1' ? false : isR1,
                     isR2Completed: isR2,
                     isClosed: isClosed,
                     comments: document.getElementById('modalNote').value.trim(),
                     proposedAmount: deleteField(),
                     scores: deleteField(),
                     lastUpdatedAt:Timestamp.now()
                 };
                 
                 if (isR2) { dTU.prospectDateR2 = document.getElementById('modalProspectDateR2').value || null; dTU.prospectTimeR2 = document.getElementById('modalProspectTimeR2').value || null; }
                 else { dTU.prospectDateR2 = deleteField(); dTU.prospectTimeR2 = deleteField(); }
                 
                 if (nS === 'Waiting') { dTU.relaunchDate = document.getElementById('modalRelaunchDate').value || null; } 
                 else { dTU.relaunchDate = deleteField(); }
                 
                 dTU.lostReason=deleteField();

                 if(isClosed){
                    const closingDate = document.getElementById('modalClosingDate').value;
                    if (!closingDate) { throw new Error("La date de closing est requise."); }
                    dTU.closingDate = closingDate;

                    const nPT=document.getElementById('modalPaymentType').value;
                    dTU.paymentType=nPT;
                    dTU.amountCollected=Number(document.getElementById('modalAmountCollected').value)||0;
                    if(nPT==='installments'){
                        const nIA=Number(document.getElementById('modalInstallmentAmount').value)||0;
                        const nNI=parseInt(document.getElementById('modalNumberOfInstallments').value)||0;
                        const nSD=document.getElementById('modalStartDateOfPayment').value||null;
                        if(!nIA||!nNI||!nSD){throw new Error("Détails échelonnement manquants.");}
                        dTU.installmentAmount=nIA;dTU.numberOfInstallments=nNI;dTU.startDateOfPayment=nSD;
                    } else {
                        dTU.installmentAmount=deleteField();dTU.numberOfInstallments=deleteField();dTU.startDateOfPayment=deleteField();
                    }
                 } else {
                    dTU.closingDate=deleteField();
                    dTU.paymentType=deleteField();dTU.amountCollected=deleteField();dTU.installmentAmount=deleteField();dTU.numberOfInstallments=deleteField();dTU.startDateOfPayment=deleteField();
                 }
                 
                await updateDoc(dR,dTU);
                closeEditModal();
                
                const docIndex = currentData.findIndex(item => item.id === dId);
                if (docIndex > -1) { 
                    const updatedProspect = { ...currentData[docIndex] };
                    Object.keys(dTU).forEach(key => {
                        const value = dTU[key];
                        if (value && typeof value === 'object' && value._doNotReadJustReturnUndefined === true) {
                            delete updatedProspect[key];
                        } else {
                            updatedProspect[key] = value;
                        }
                    });
                    currentData[docIndex] = updatedProspect;
                }
                renderFilteredData(); 
                 renderReliabilityGauge(); 
                 renderDecisionEngine(); // Update Engine
             } catch(error){ console.error("Err update:",error); mE.textContent=error.message || "Erreur sauvegarde."; }
             finally { sB.disabled=false; sB.textContent='Enregistrer'; }
        }
        function openDeleteConfirmModal(docId, prospectName) { document.getElementById('deleteProspectName').textContent=prospectName;document.getElementById('deleteDocId').value=docId;document.getElementById('deleteError').textContent='';document.getElementById('deleteConfirmModal').classList.remove('hidden'); }
        function closeDeleteConfirmModal() { document.getElementById('deleteConfirmModal').classList.add('hidden'); }
        async function confirmDeletion() { const dId=document.getElementById('deleteDocId').value;const dE=document.getElementById('deleteError');const cB=document.getElementById('deleteConfirmButton');if(!dId){dE.textContent="ID manquant.";return;} dE.textContent='';cB.disabled=true;cB.textContent='Suppression...';try{const cP=`artifacts/${appId}/public/data/r1_closings`;const dR=doc(db,cP,dId);await deleteDoc(dR);closeDeleteConfirmModal(); currentData = currentData.filter(item => item.id !== dId); renderFilteredData(); renderReliabilityGauge(); renderDecisionEngine(); }catch(error){console.error(`Err suppression ${dId}:`,error);dE.textContent="Erreur suppression.";}finally{cB.disabled=false;cB.textContent='Supprimer';} }
        function openStartR1ConfirmModal(docId, prospectName) { document.getElementById('startR1ProspectName').textContent = prospectName; document.getElementById('startR1DocId').value = docId; document.getElementById('startR1Error').textContent = ''; document.getElementById('startR1ConfirmModal').classList.remove('hidden'); }
        function closeStartR1ConfirmModal() { document.getElementById('startR1ConfirmModal').classList.add('hidden'); }
        async function handleNoShow() { const docId = document.getElementById('startR1DocId').value; const errorP = document.getElementById('startR1Error'); const noShowButton = document.getElementById('noShowButton'); if (!docId || !db) { errorP.textContent = 'Erreur ID/DB'; return; } errorP.textContent = ''; noShowButton.disabled = true; noShowButton.textContent = 'Enregistrement...'; try { const collectionPath = `artifacts/${appId}/public/data/r1_closings`; const docRef = doc(db, collectionPath, docId); await updateDoc(docRef, { status: 'No Show R1', isR1Completed: false, isR2Completed: false, isClosed: false, lastUpdatedAt: Timestamp.now() }); closeStartR1ConfirmModal(); const docIndex = currentData.findIndex(item => item.id === docId); if (docIndex > -1) { currentData[docIndex].status = 'No Show R1'; currentData[docIndex].isR1Completed = false; currentData[docIndex].isR2Completed = false; currentData[docIndex].isClosed = false;} renderFilteredData(); } catch (error) { console.error(`Erreur No Show ${docId}:`, error); errorP.textContent = 'Erreur sauvegarde No Show.'; } finally { noShowButton.disabled = false; noShowButton.textContent = 'Absent (No Show)'; } }
        async function handleStartR1Confirm() {
            const docId = document.getElementById('startR1DocId').value;
            const errorP = document.getElementById('startR1Error');
            const confirmButton = document.getElementById('startR1ConfirmButton');

            if (!docId || !db) {
                errorP.textContent = 'Erreur: ID ou connexion DB manquante.';
                return;
            }

            errorP.textContent = '';
            confirmButton.disabled = true;
            confirmButton.textContent = 'Démarrage...';

            try {
                const collectionPath = `artifacts/${appId}/public/data/r1_closings`;
                const docRef = doc(db, collectionPath, docId);
                
                await updateDoc(docRef, { 
                    status: 'R1 Completed', 
                    isR1Completed: true,
                    lastUpdatedAt: Timestamp.now() 
                });

                const docIndex = currentData.findIndex(item => item.id === docId);
                if (docIndex > -1) {
                    currentData[docIndex].status = 'R1 Completed';
                    currentData[docIndex].isR1Completed = true;
                }
                
                window.location.href = `main.html?docId=${docId}`;
                closeStartR1ConfirmModal();

            } catch (error) {
                console.error(`Erreur lors du démarrage du R1 ${docId}:`, error);
                errorP.textContent = 'Erreur lors de la sauvegarde.';
            } finally {
                confirmButton.disabled = false;
                confirmButton.textContent = 'Présent (Démarrer)';
            }
        }
        
        async function handlePrequalStatusCycle(docId, currentStatus) {
            const statusCycle = ['none', 'sent', 'confirmed', 'rejected'];
            const currentIndex = statusCycle.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statusCycle.length;
            const nextStatus = statusCycle[nextIndex];

            const button = document.querySelector(`.prequal-status-btn[data-doc-id="${docId}"]`);
            if (button) button.disabled = true;

            try {
                const collectionPath = `artifacts/${appId}/public/data/r1_closings`;
                const docRef = doc(db, collectionPath, docId);
                const dataToUpdate = { lastUpdatedAt: Timestamp.now() };

                if (nextStatus === 'none') {
                    dataToUpdate.prequalStatus = deleteField();
                } else {
                    dataToUpdate.prequalStatus = nextStatus;
                }
                
                await updateDoc(docRef, dataToUpdate);

                const docIndex = currentData.findIndex(item => item.id === docId);
                if (docIndex > -1) {
                    if (nextStatus === 'none') {
                        delete currentData[docIndex].prequalStatus;
                    } else {
                        currentData[docIndex].prequalStatus = nextStatus;
                    }
                }
                displayError(`Statut pré-qualif mis à jour.`, false);
                renderFilteredData(); 

            } catch (error) {
                console.error(`Erreur mise à jour pré-qualif ${docId}:`, error);
                displayError("Erreur sauvegarde pré-qualif.", true);
                if (button) button.disabled = false;
            }
        }

        async function handleTableCheckboxChange(checkbox) {
            const docId = checkbox.dataset.docId;
            const action = checkbox.dataset.action;
            const isChecked = checkbox.checked;

            checkbox.classList.add('checkbox-loading');
            checkbox.disabled = true;

            try {
                const prospectIndex = currentData.findIndex(p => p.id === docId);
                if (prospectIndex === -1) throw new Error("Prospect non trouvé localement.");
                
                const currentProspect = { ...currentData[prospectIndex] };
                let updates = { lastUpdatedAt: Timestamp.now() };

                let newIsR1 = currentProspect.isR1Completed || false;
                let newIsR2 = currentProspect.isR2Completed || false;
                let newIsClosed = currentProspect.isClosed || false;

                if (action === 'r1_fait') newIsR1 = isChecked;
                if (action === 'r2_prevu') newIsR2 = isChecked;
                if (action === 'close') newIsClosed = isChecked;

                if (isChecked) {
                    if (newIsClosed) newIsR2 = true;
                    if (newIsR2) newIsR1 = true;
                } else {
                    if (!newIsR1) newIsR2 = false;
                    if (!newIsR2) newIsClosed = false;
                }

                if (newIsR1 !== (currentProspect.isR1Completed || false)) updates.isR1Completed = newIsR1;
                if (newIsR2 !== (currentProspect.isR2Completed || false)) updates.isR2Completed = newIsR2;
                if (newIsClosed !== (currentProspect.isClosed || false)) updates.isClosed = newIsClosed;
                
                let newStatus = 'R1 Scheduled';
                if (newIsClosed) {
                    newStatus = 'Closed';
                    if (!currentProspect.closingDate) {
                        updates.closingDate = getISODate(new Date());
                    }
                } else if (newIsR2) {
                    newStatus = 'R2 Scheduled';
                } else if (newIsR1) {
                    newStatus = 'R1 Completed';
                }
                
                const exceptionStatuses = ['Waiting', 'No Show R1', 'No Show R2', 'Disqualified', 'Lost'];
                if (newStatus !== currentProspect.status && !exceptionStatuses.includes(currentProspect.status)) {
                    updates.status = newStatus;
                }

                if (Object.keys(updates).length > 1) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/r1_closings`, docId);
                    await updateDoc(docRef, updates);

                    currentData[prospectIndex] = { ...currentProspect, ...updates };
                    displayError("Statut mis à jour.", false);
                }

                renderFilteredData();
                renderReliabilityGauge(); 
                renderDecisionEngine();

            } catch (error) {
                console.error(`Erreur de mise à jour pour ${docId}:`, error);
                displayError("Erreur de mise à jour.", true);
                checkbox.checked = !isChecked; 
            }
        }

        async function handleFinalStatusChange(docId, selectElement) {
            const newStatus = selectElement.value;
            const originalStatus = selectElement.dataset.originalStatus;

            if (newStatus === originalStatus) return;
            
            displayError("Mise à jour...", false);
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/r1_closings`, docId);
                const prospect = currentData.find(p => p.id === docId);
                if (!prospect) throw new Error("Prospect not found");

                const dataToUpdate = { lastUpdatedAt: Timestamp.now() };

                if (newStatus) {
                    dataToUpdate.status = newStatus;
                    if (newStatus === 'No Show R1') dataToUpdate.isR1Completed = false;
                    if (newStatus === 'No Show R2') dataToUpdate.isR2Completed = false;
                    if (newStatus === 'Lost' || newStatus === 'Disqualified') dataToUpdate.isClosed = false;
                } else {
                    if (prospect.isClosed) dataToUpdate.status = 'Closed';
                    else if (prospect.isR2Completed) dataToUpdate.status = 'R2 Scheduled';
                    else if (prospect.isR1Completed) dataToUpdate.status = 'R1 Completed';
                    else dataToUpdate.status = 'R1 Scheduled';
                }

                await updateDoc(docRef, dataToUpdate);
                const docIndex = currentData.findIndex(item => item.id === docId);
                if (docIndex > -1) { currentData[docIndex] = { ...currentData[docIndex], ...dataToUpdate }; }
                
                displayError("Statut mis à jour.", false);
                renderFilteredData();
                renderReliabilityGauge(); 
                renderDecisionEngine();
            } catch (error) {
                console.error(`Erreur mise à jour statut ${docId}:`, error);
                displayError("Erreur de mise à jour.", true);
                selectElement.value = originalStatus;
            }
        }

        function openAnnotationModal(dateStr = null) {
            document.getElementById('annotationModal').classList.remove('hidden');
            document.getElementById('annotationDate').value = dateStr || getISODate(new Date());
            document.getElementById('annotationComment').value = '';
            document.getElementById('annotationError').textContent = '';
        }

        function closeAnnotationModal() {
            document.getElementById('annotationModal').classList.add('hidden');
        }
        
        async function saveAnnotation() {
            const date = document.getElementById('annotationDate').value;
            const comment = document.getElementById('annotationComment').value.trim();
            const errorEl = document.getElementById('annotationError');
            if (!date || !comment) { errorEl.textContent = "Date et description sont requises."; return; }

            const saveButton = document.getElementById('annotationSaveButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Sauvegarde...';
            errorEl.textContent = '';

            try {
                const collectionPath = `artifacts/${appId}/public/data/chart_annotations`;
                const dataToSave = { date: date, comment: comment, createdAt: Timestamp.now() };
                const newDocRef = await addDoc(collection(db, collectionPath), dataToSave);
                annotationsData.push({ id: newDocRef.id, ...dataToSave });
                renderFilteredData();
                renderReliabilityGauge(); 
                renderDecisionEngine(); // Recalculate based on new annotation
                closeAnnotationModal();
            } catch (error) {
                console.error("Error saving annotation:", error);
                errorEl.textContent = "Erreur lors de la sauvegarde.";
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Enregistrer';
            }
        }

        async function deleteAnnotation(docId) {
            try {
                displayError("Suppression de l'événement...", false);
                const collectionPath = `artifacts/${appId}/public/data/chart_annotations`;
                await deleteDoc(doc(db, collectionPath, docId));
                annotationsData = annotationsData.filter(a => a.id !== docId);
                renderFilteredData();
                renderReliabilityGauge(); 
                renderDecisionEngine(); // Recalculate
            } catch(error) {
                console.error("Error deleting annotation:", error);
                displayError("Erreur de suppression.", true);
            }
        }

        function attachListeners() { 
            const tableBody = document.getElementById('detailsTableBody');
            if(tableBody) tableBody.addEventListener('click',(e)=>{ 
                const target = e.target;
                const docId = target.dataset.docId;
                if(target.classList.contains('edit-btn')){ 
                    openEditModal(docId);
                } 
                else if(target.classList.contains('delete-btn')){ openDeleteConfirmModal(docId, target.dataset.prospectName); } 
                else if(target.classList.contains('start-r1-prompt-btn')) { openStartR1ConfirmModal(docId, target.dataset.prospectName); }
                else if (target.closest('.prequal-status-btn')) { const btn = target.closest('.prequal-status-btn'); handlePrequalStatusCycle(btn.dataset.docId, btn.dataset.status); }
            }); 
            if(tableBody) tableBody.addEventListener('change', (e) => {
                const target = e.target;
                if (target.classList.contains('status-select')) {
                    handleFinalStatusChange(target.dataset.docId, target);
                } else if (target.classList.contains('custom-checkbox')) {
                    handleTableCheckboxChange(target);
                }
            });

            document.getElementById('modalCancelButton')?.addEventListener('click',closeEditModal);
            document.getElementById('modalSaveButton')?.addEventListener('click',saveModalChanges);
            document.getElementById('editModal')?.addEventListener('click',(e)=>{if(e.target.id==='editModal')closeEditModal();}); 
            document.getElementById('deleteCancelButton')?.addEventListener('click',closeDeleteConfirmModal);
            document.getElementById('deleteConfirmButton')?.addEventListener('click',confirmDeletion);
            document.getElementById('deleteConfirmModal')?.addEventListener('click',(e)=>{if(e.target.id==='deleteConfirmModal')closeDeleteConfirmModal();}); 
            document.getElementById('startR1CancelButton')?.addEventListener('click', closeStartR1ConfirmModal); 
            document.getElementById('noShowButton')?.addEventListener('click', handleNoShow); 
            document.getElementById('startR1ConfirmButton')?.addEventListener('click', handleStartR1Confirm); 
            document.getElementById('startR1ConfirmModal')?.addEventListener('click', (e) => { if (e.target.id === 'startR1ConfirmModal') closeStartR1ConfirmModal(); }); 

            // Annotation Modal Listeners
            document.getElementById('annotationCancelButton')?.addEventListener('click', closeAnnotationModal);
            document.getElementById('annotationSaveButton')?.addEventListener('click', saveAnnotation);
            document.getElementById('annotationModal')?.addEventListener('click', (e) => { if(e.target.id === 'annotationModal') closeAnnotationModal(); });
            
            // Settings Listeners
            document.getElementById('openSettingsBtn')?.addEventListener('click', openSettingsModal);
            document.getElementById('closeSettingsBtn')?.addEventListener('click', () => document.getElementById('settingsModal').classList.add('hidden'));
            document.getElementById('saveSettingsBtn')?.addEventListener('click', saveKpiSettings);
            document.getElementById('settingsModal')?.addEventListener('click', (e) => { if(e.target.id === 'settingsModal') document.getElementById('settingsModal').classList.add('hidden'); });
        }
        
        // --- Démarrage ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if(window.ChartAnnotation) {
                    Chart.register(window.ChartAnnotation);
                }
                await initFirebase();
                await fetchDataAndDisplay();
            } catch (error) {
                console.error("Erreur critique au démarrage:", error);
                displayError("Erreur de chargement initiale. Vérifiez la console.", true);
            }
        });

    </script>

</body>
</html>